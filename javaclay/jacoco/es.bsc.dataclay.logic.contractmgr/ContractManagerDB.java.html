<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContractManagerDB.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dataclay</a> &gt; <a href="index.source.html" class="el_package">es.bsc.dataclay.logic.contractmgr</a> &gt; <span class="el_source">ContractManagerDB.java</span></div><h1>ContractManagerDB.java</h1><pre class="source lang-java linenums">
package es.bsc.dataclay.logic.contractmgr;

import java.sql.Array;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.UUID;

import org.apache.commons.dbcp2.BasicDataSource;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import es.bsc.dataclay.exceptions.dbhandler.DbObjectAlreadyExistException;
import es.bsc.dataclay.exceptions.dbhandler.DbObjectNotExistException;
import es.bsc.dataclay.logic.interfacemgr.InterfaceManagerDB;
import es.bsc.dataclay.util.Configuration;
import es.bsc.dataclay.util.ids.AccountID;
import es.bsc.dataclay.util.ids.ContractID;
import es.bsc.dataclay.util.ids.ImplementationID;
import es.bsc.dataclay.util.ids.InterfaceID;
import es.bsc.dataclay.util.ids.NamespaceID;
import es.bsc.dataclay.util.ids.OperationID;
import es.bsc.dataclay.util.management.contractmgr.Contract;
import es.bsc.dataclay.util.management.contractmgr.InterfaceInContract;
import es.bsc.dataclay.util.management.contractmgr.OpImplementations;
import es.bsc.dataclay.util.management.interfacemgr.Interface;
import es.bsc.dataclay.dbhandler.sql.sqlite.SQLiteDataSource;

/**
 * Data base connection.
 */
public final class ContractManagerDB {

	/** Logger. */
	private Logger logger;

	/** Indicates if debug is enabled. */
<span class="fc" id="L48">	private static final boolean DEBUG_ENABLED = Configuration.isDebugEnabled();</span>

	/** SingleConnection. */
	private final SQLiteDataSource dataSource;

	/** Interface Manager DB needed for InterfaceInContract. TODO: this should be not together. */
	private final InterfaceManagerDB ifaceManagerDB;

	/**
	 * MetaDataServiceDB constructor.
	 * 
	 * @param dataSource
	 *            Name of the LM service managing.
	 */
<span class="fc" id="L62">	public ContractManagerDB(final SQLiteDataSource dataSource) {</span>
<span class="fc" id="L63">		this.dataSource = dataSource;</span>
<span class="fc" id="L64">		ifaceManagerDB = new InterfaceManagerDB(dataSource);</span>
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">		if (DEBUG_ENABLED) {</span>
<span class="nc" id="L66">			logger = LogManager.getLogger(&quot;LMDB&quot;);</span>
		}
<span class="fc" id="L68">	}</span>

	/**
	 * Create tables of MDS.
	 */
	public void createTables() {
<span class="fc" id="L74">		synchronized (dataSource) {</span>
<span class="fc" id="L75">			Connection conn = null;</span>
			try {
<span class="fc" id="L77">				conn = dataSource.getConnection();</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">				for (final ContractManagerSQLStatements.SqlStatements stmt : ContractManagerSQLStatements.SqlStatements.values()) {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">					if (stmt.name().startsWith(&quot;CREATE_TABLE&quot;)) {</span>
<span class="fc" id="L80">						final PreparedStatement updateStatement = conn.prepareStatement(stmt.getSqlStatement());</span>
<span class="fc" id="L81">						updateStatement.execute();</span>
<span class="fc" id="L82">						updateStatement.close();</span>
					}
				}
<span class="nc" id="L85">			} catch (final SQLException e) {</span>
<span class="nc" id="L86">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L90">						conn.close();</span>
					}
<span class="nc" id="L92">				} catch (final SQLException ex1) {</span>
<span class="nc" id="L93">					ex1.printStackTrace();</span>
<span class="fc" id="L94">				}</span>
			}
<span class="fc" id="L96">		}</span>
<span class="fc" id="L97">	}</span>

	/**
	 * Delete the tables of MDS. Just the other way around of createTables --much simpler.
	 */
	public void dropTables() {
<span class="fc" id="L103">		synchronized (dataSource) {</span>
<span class="fc" id="L104">			Connection conn = null;</span>
			try {
<span class="fc" id="L106">				conn = dataSource.getConnection();</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">				for (final ContractManagerSQLStatements.SqlStatements stmt : ContractManagerSQLStatements.SqlStatements.values()) {</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">					if (stmt.name().startsWith(&quot;DROP_TABLE&quot;)) {</span>
<span class="fc" id="L109">						final PreparedStatement updateStatement = conn.prepareStatement(stmt.getSqlStatement());</span>
<span class="fc" id="L110">						updateStatement.execute();</span>
<span class="fc" id="L111">						updateStatement.close();</span>
					}
				}
<span class="nc" id="L114">			} catch (final SQLException e) {</span>
<span class="nc" id="L115">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L119">						conn.close();</span>
					}
<span class="nc" id="L121">				} catch (final SQLException ex1) {</span>
<span class="nc" id="L122">					ex1.printStackTrace();</span>
<span class="fc" id="L123">				}</span>
			}
<span class="fc" id="L125">		}</span>
<span class="fc" id="L126">	}</span>

	/**
	 * Store opImplementations into database
	 * @param opImplementations
	 *            opImplementations
	 * @return uuid of stored object
	 */
	public UUID store(final OpImplementations opImplementations) {
<span class="fc" id="L135">		synchronized (dataSource) {</span>
<span class="fc" id="L136">			Connection conn = null;</span>
<span class="fc" id="L137">			final UUID uuid = UUID.randomUUID();</span>
<span class="fc" id="L138">			opImplementations.setId(uuid);</span>
			try {
<span class="fc" id="L140">				conn = dataSource.getConnection();</span>
<span class="fc" id="L141">				final PreparedStatement insertStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.INSERT_OPIMPLEMENTATIONS.getSqlStatement());</span>
<span class="fc" id="L142">				insertStatement.setObject(1, uuid);</span>
				// CHECKSTYLE:OFF
<span class="fc" id="L144">				insertStatement.setString(2, opImplementations.getOperationSignature());</span>
<span class="fc" id="L145">				insertStatement.setInt(3, opImplementations.getNumLocalImpl());</span>
<span class="fc" id="L146">				insertStatement.setInt(4, opImplementations.getNumRemoteImpl());</span>
<span class="fc" id="L147">				insertStatement.setObject(5, opImplementations.getLocalImplementationID().getId());</span>
<span class="fc" id="L148">				insertStatement.setObject(6, opImplementations.getRemoteImplementationID().getId());</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L150">					logger.debug(&quot;[==DB==] Executing &quot; + insertStatement);</span>
				}
				// CHECKSTYLE:ON
<span class="fc" id="L153">				insertStatement.executeUpdate();</span>
<span class="fc" id="L154">				insertStatement.close();</span>
<span class="nc" id="L155">			} catch (final Exception e) {</span>
<span class="nc" id="L156">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L160">						conn.close();</span>
					}
<span class="nc" id="L162">				} catch (final SQLException ex1) {</span>
<span class="nc" id="L163">					ex1.printStackTrace();</span>
<span class="fc" id="L164">				}</span>
			}
<span class="fc" id="L166">			return uuid;</span>
		}
	}

	/**
	 * Store ifaceInContract into database
	 * @param ifaceInContract
	 *            ifaceInContract
	 * @return uuid of stored object
	 */
	public UUID store(final InterfaceInContract ifaceInContract) {
<span class="fc" id="L177">		synchronized (dataSource) {</span>
<span class="fc" id="L178">			final UUID uuid = UUID.randomUUID();</span>
<span class="fc" id="L179">			ifaceInContract.setId(uuid);</span>

<span class="fc" id="L181">			UUID[] implsSpecs = null;</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">			if (ifaceInContract.getImplementationsSpecPerOperation() != null) {</span>
<span class="fc" id="L183">				implsSpecs = new UUID[ifaceInContract.getImplementationsSpecPerOperation().size()];</span>
<span class="fc" id="L184">				int i = 0;</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">				for (final OpImplementations opImpls : ifaceInContract.getImplementationsSpecPerOperation()) {</span>
<span class="fc" id="L186">					implsSpecs[i] = this.store(opImpls);</span>
<span class="fc" id="L187">					i++;</span>
<span class="fc" id="L188">				}</span>
			}

<span class="fc" id="L191">			UUID[] accessibleImplementationsUUIDsKeys = null;</span>
<span class="fc" id="L192">			UUID[] accessibleImplementationsUUIDsValues = null;</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">			if (ifaceInContract.getAccessibleImplementations() != null) {</span>
<span class="fc" id="L194">				accessibleImplementationsUUIDsKeys = new UUID[ifaceInContract.getAccessibleImplementations().size()];</span>
<span class="fc" id="L195">				accessibleImplementationsUUIDsValues = new UUID[ifaceInContract.getAccessibleImplementations().size()];</span>
<span class="fc" id="L196">				int i = 0;</span>
<span class="fc bfc" id="L197" title="All 2 branches covered.">				for (final Entry&lt;OperationID, OpImplementations&gt; entry : ifaceInContract.getAccessibleImplementations().entrySet()) {</span>
<span class="fc" id="L198">					accessibleImplementationsUUIDsKeys[i] = entry.getKey().getId();</span>
<span class="fc" id="L199">					accessibleImplementationsUUIDsValues[i] = this.store(entry.getValue());</span>
<span class="fc" id="L200">					i++;</span>
<span class="fc" id="L201">				}</span>
			}

<span class="fc" id="L204">			Connection conn = null;</span>
			try {
<span class="fc" id="L206">				conn = dataSource.getConnection();</span>
<span class="fc" id="L207">				final PreparedStatement insertStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.INSERT_IFACEINCONTRACT.getSqlStatement());</span>
<span class="fc" id="L208">				insertStatement.setObject(1, uuid);</span>
				// CHECKSTYLE:OFF
<span class="fc" id="L210">				insertStatement.setObject(2, ifaceInContract.getInterfaceID().getId());</span>

<span class="fc bfc" id="L212" title="All 2 branches covered.">				if (implsSpecs != null) {</span>
<span class="fc" id="L213">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, implsSpecs);</span>
<span class="fc" id="L214">					insertStatement.setArray(3, tArray);</span>
<span class="fc" id="L215">				} else {</span>
<span class="fc" id="L216">					insertStatement.setArray(3, null);</span>
				}

<span class="pc bpc" id="L219" title="1 of 2 branches missed.">				if (accessibleImplementationsUUIDsKeys != null) {</span>
<span class="fc" id="L220">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, accessibleImplementationsUUIDsKeys);</span>
<span class="fc" id="L221">					insertStatement.setArray(4, tArray);</span>
<span class="fc" id="L222">				} else {</span>
<span class="nc" id="L223">					insertStatement.setArray(4, null);</span>
				}

<span class="pc bpc" id="L226" title="1 of 2 branches missed.">				if (accessibleImplementationsUUIDsValues != null) {</span>
<span class="fc" id="L227">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, accessibleImplementationsUUIDsValues);</span>
<span class="fc" id="L228">					insertStatement.setArray(5, tArray);</span>
<span class="fc" id="L229">				} else {</span>
<span class="nc" id="L230">					insertStatement.setArray(5, null);</span>
				}

				// CHECKSTYLE:ON
<span class="pc bpc" id="L234" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L235">					logger.debug(&quot;[==DB==] Executing &quot; + insertStatement);</span>
				}
<span class="fc" id="L237">				insertStatement.executeUpdate();</span>
<span class="fc" id="L238">				insertStatement.close();</span>
<span class="nc" id="L239">			} catch (final Exception e) {</span>
<span class="nc" id="L240">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L244">						conn.close();</span>
					}
<span class="nc" id="L246">				} catch (final SQLException ex1) {</span>
<span class="nc" id="L247">					ex1.printStackTrace();</span>
<span class="fc" id="L248">				}</span>
			}
<span class="fc" id="L250">			return uuid;</span>
		}

	}

	/**
	 * Store contract into database
	 * @param contract
	 *            contract
	 */
	public void store(final Contract contract) {
<span class="fc" id="L261">		synchronized (dataSource) {</span>
<span class="fc" id="L262">			UUID[] ifaces = null;</span>
<span class="fc" id="L263">			UUID[] ifacesKeys = null;</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">			if (contract.getInterfacesInContract() != null) {</span>
<span class="fc" id="L265">				ifaces = new UUID[contract.getInterfacesInContract().size()];</span>
<span class="fc" id="L266">				ifacesKeys = new UUID[contract.getInterfacesInContract().size()];</span>
<span class="fc" id="L267">				int i = 0;</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">				for (final InterfaceInContract ifaceInContract : contract.getInterfacesInContract().values()) {</span>
<span class="fc" id="L269">					ifaces[i] = this.store(ifaceInContract);</span>
<span class="fc" id="L270">					ifacesKeys[i] = ifaceInContract.getIface().getDataClayID().getId();</span>
<span class="fc" id="L271">					i++;</span>
<span class="fc" id="L272">				}</span>
			}

<span class="fc" id="L275">			UUID[] accountsUUIDs = null;</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">			if (contract.getApplicantsAccountsIDs() != null) {</span>
<span class="fc" id="L277">				accountsUUIDs = new UUID[contract.getApplicantsAccountsIDs().size()];</span>
<span class="fc" id="L278">				int i = 0;</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">				for (final AccountID accountID : contract.getApplicantsAccountsIDs()) {</span>
<span class="fc" id="L280">					accountsUUIDs[i] = accountID.getId();</span>
<span class="fc" id="L281">					i++;</span>
<span class="fc" id="L282">				}</span>
			}

<span class="fc" id="L285">			Connection conn = null;</span>
			try {
<span class="fc" id="L287">				conn = dataSource.getConnection();</span>
<span class="fc" id="L288">				final PreparedStatement insertStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.INSERT_CONTRACT.getSqlStatement());</span>
<span class="fc" id="L289">				insertStatement.setObject(1, contract.getDataClayID().getId());</span>
				// CHECKSTYLE:OFF
<span class="fc" id="L291">				insertStatement.setString(2, contract.getNamespace());</span>

<span class="fc" id="L293">				insertStatement.setTimestamp(3, new java.sql.Timestamp(contract.getBeginDate().getTimeInMillis()));</span>
<span class="fc" id="L294">				insertStatement.setTimestamp(4, new java.sql.Timestamp(contract.getEndDate().getTimeInMillis()));</span>
<span class="fc" id="L295">				insertStatement.setBoolean(5, contract.isPublicAvailable());</span>
<span class="fc" id="L296">				insertStatement.setObject(6, contract.getProviderAccountID().getId());</span>
<span class="fc" id="L297">				insertStatement.setObject(7, contract.getNamespaceID().getId());</span>

<span class="pc bpc" id="L299" title="1 of 2 branches missed.">				if (accountsUUIDs != null) {</span>
<span class="fc" id="L300">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, accountsUUIDs);</span>
<span class="fc" id="L301">					insertStatement.setArray(8, tArray);</span>
<span class="fc" id="L302">				} else {</span>
<span class="nc" id="L303">					insertStatement.setArray(8, null);</span>
				}

<span class="pc bpc" id="L306" title="1 of 2 branches missed.">				if (ifacesKeys != null) {</span>
<span class="fc" id="L307">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, ifacesKeys);</span>
<span class="fc" id="L308">					insertStatement.setArray(9, tArray);</span>
<span class="fc" id="L309">				} else {</span>
<span class="nc" id="L310">					insertStatement.setArray(9, null);</span>
				}

<span class="pc bpc" id="L313" title="1 of 2 branches missed.">				if (ifaces != null) {</span>
<span class="fc" id="L314">					final Array tArray = insertStatement.getConnection().createArrayOf(&quot;uuid&quot;, ifaces);</span>
<span class="fc" id="L315">					insertStatement.setArray(10, tArray);</span>
<span class="fc" id="L316">				} else {</span>
<span class="nc" id="L317">					insertStatement.setArray(10, null);</span>
				}

				// CHECKSTYLE:ON
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L322">					logger.debug(&quot;[==DB==] Executing &quot; + insertStatement);</span>
				}
<span class="fc" id="L324">				insertStatement.executeUpdate();</span>
<span class="fc" id="L325">				insertStatement.close();</span>
<span class="nc" id="L326">			} catch (final Exception e) {</span>
<span class="nc" id="L327">				e.printStackTrace();</span>
<span class="nc" id="L328">				throw new DbObjectAlreadyExistException(contract.getDataClayID());</span>
			} finally {
				try {
<span class="pc bpc" id="L331" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L332">						conn.close();</span>
					}
<span class="nc" id="L334">				} catch (final SQLException ex1) {</span>
<span class="nc" id="L335">					ex1.printStackTrace();</span>
<span class="fc" id="L336">				}</span>
			}
<span class="fc" id="L338">		}</span>
<span class="fc" id="L339">	}</span>

	/**
	 * Deserialize
	 * @param rs
	 *            Result set
	 * @return OpImplementations
	 */
	private OpImplementations deserializeOpImplementations(
			final ResultSet rs) {
<span class="fc" id="L349">		OpImplementations result = null;</span>
		try {
			// CHECKSTYLE:OFF
<span class="fc" id="L352">			final UUID id = (UUID)rs.getObject(&quot;id&quot;);</span>
<span class="fc" id="L353">			final String operationSignature = rs.getString(&quot;operationSignature&quot;);</span>
<span class="fc" id="L354">			final int numLocalImpl = rs.getInt(&quot;numLocalImpl&quot;);</span>
<span class="fc" id="L355">			final int numRemoteImpl = rs.getInt(&quot;numRemoteImpl&quot;);</span>

<span class="fc" id="L357">			final ImplementationID localImplementationID = new ImplementationID((UUID)rs.getObject(&quot;localImplementationID&quot;));</span>
<span class="fc" id="L358">			final ImplementationID remoteImplementationID = new ImplementationID((UUID)rs.getObject(&quot;remoteImplementationID&quot;));</span>

<span class="fc" id="L360">			result = new OpImplementations();</span>
<span class="fc" id="L361">			result.setId(id);</span>
<span class="fc" id="L362">			result.setLocalImplementationID(localImplementationID);</span>
<span class="fc" id="L363">			result.setNumLocalImpl(numLocalImpl);</span>
<span class="fc" id="L364">			result.setNumRemoteImpl(numRemoteImpl);</span>
<span class="fc" id="L365">			result.setOperationSignature(operationSignature);</span>
<span class="fc" id="L366">			result.setRemoteImplementationID(remoteImplementationID);</span>

<span class="nc" id="L368">		} catch (final SQLException e) {</span>
<span class="nc" id="L369">			e.printStackTrace();</span>
<span class="fc" id="L370">		}</span>
<span class="fc" id="L371">		return result;</span>
	}

	/**
	 * Deserialize
	 * @param rs
	 *            Result set
	 * @return InterfaceInContract
	 */
	private InterfaceInContract deserializeInterfaceInContract(
			final ResultSet rs) {
<span class="fc" id="L382">		InterfaceInContract result = null;</span>
		try {
			// CHECKSTYLE:OFF
<span class="fc" id="L385">			final UUID id = (UUID)rs.getObject(&quot;id&quot;);</span>
<span class="fc" id="L386">			final UUID interfaceUUID = (UUID)rs.getObject(&quot;interface&quot;);</span>
<span class="fc" id="L387">			final InterfaceID interfaceID = new InterfaceID(interfaceUUID);</span>
<span class="fc" id="L388">			final Interface iface = ifaceManagerDB.getInterfaceByID(interfaceID);</span>

<span class="fc" id="L390">			final Array array = rs.getArray(&quot;implementationsSpecPerOperation&quot;);</span>
<span class="fc" id="L391">			UUID[] implementationsSpecPerOperationUUIDs = null;</span>
<span class="fc" id="L392">			final Set&lt;OpImplementations&gt; implementationsSpecPerOperation = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L393" title="All 2 branches covered.">			if (array != null) {</span>
<span class="fc" id="L394">				implementationsSpecPerOperationUUIDs = (UUID[]) array.getArray();</span>
<span class="fc bfc" id="L395" title="All 2 branches covered.">				for (final UUID implSpecUUID : implementationsSpecPerOperationUUIDs) {</span>
<span class="fc" id="L396">					implementationsSpecPerOperation.add(this.getOpImplementationsByID(implSpecUUID));</span>
				}
			}

<span class="fc" id="L400">			final Array array1 = rs.getArray(&quot;accessibleImplementationsKeys&quot;);</span>
<span class="fc" id="L401">			final Array array2 = rs.getArray(&quot;accessibleImplementationsValues&quot;);</span>
<span class="fc" id="L402">			UUID[] accessibleImplementationsKeysUUIDs = null;</span>
<span class="fc" id="L403">			UUID[] accessibleImplementationsValuesUUIDs = null;</span>
<span class="fc" id="L404">			final Map&lt;OperationID, OpImplementations&gt; accessibleImplementations = new HashMap&lt;&gt;();</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">			if (array1 != null) {</span>
<span class="fc" id="L406">				accessibleImplementationsKeysUUIDs = (UUID[]) array1.getArray();</span>
<span class="fc" id="L407">				accessibleImplementationsValuesUUIDs = (UUID[]) array2.getArray();</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">				for (int i = 0; i &lt; accessibleImplementationsKeysUUIDs.length; ++i) {</span>
<span class="fc" id="L409">					final OperationID opID = new OperationID(accessibleImplementationsKeysUUIDs[i]);</span>
<span class="fc" id="L410">					final OpImplementations opImpl = this.getOpImplementationsByID(accessibleImplementationsValuesUUIDs[i]);</span>
<span class="fc" id="L411">					accessibleImplementations.put(opID, opImpl);</span>
				}
			}

<span class="fc" id="L415">			result = new InterfaceInContract();</span>
<span class="fc" id="L416">			result.setAccessibleImplementations(accessibleImplementations);</span>
<span class="fc" id="L417">			result.setId(id);</span>
<span class="fc" id="L418">			result.setIface(iface);</span>
<span class="fc" id="L419">			result.setImplementationsSpecPerOperation(implementationsSpecPerOperation);</span>
<span class="fc" id="L420">			result.setInterfaceID(interfaceID);</span>

<span class="nc" id="L422">		} catch (final SQLException e) {</span>
<span class="nc" id="L423">			e.printStackTrace();</span>
<span class="fc" id="L424">		}</span>
<span class="fc" id="L425">		return result;</span>
	}

	/**
	 * Deserialize
	 * @param rs
	 *            Result set
	 * @return Contract
	 */
	private Contract deserializeContract(
			final ResultSet rs) {
<span class="fc" id="L436">		Contract result = null;</span>
		try {
			// CHECKSTYLE:OFF
<span class="fc" id="L439">			final ContractID contractID = new ContractID((UUID)rs.getObject(&quot;id&quot;));</span>
<span class="fc" id="L440">			final String namespace = rs.getString(&quot;namespace&quot;);</span>
<span class="fc" id="L441">			final Calendar beginDate = Calendar.getInstance();</span>
<span class="fc" id="L442">			beginDate.setTimeInMillis(rs.getTimestamp(&quot;beginDate&quot;).getTime());</span>
<span class="fc" id="L443">			final Calendar endDate = Calendar.getInstance();</span>
<span class="fc" id="L444">			endDate.setTimeInMillis(rs.getTimestamp(&quot;endDate&quot;).getTime());</span>
<span class="fc" id="L445">			final boolean publicAvailable = rs.getBoolean(&quot;publicAvailable&quot;);</span>
<span class="fc" id="L446">			final AccountID providerAccountID = new AccountID((UUID)rs.getObject(&quot;providerAccountID&quot;));</span>
<span class="fc" id="L447">			final NamespaceID namespaceID = new NamespaceID((UUID)rs.getObject(&quot;namespaceID&quot;));</span>

<span class="fc" id="L449">			final UUID[] applicantsAccountsUUIDs = (UUID[]) rs.getArray(&quot;applicantsAccountsIDs&quot;).getArray();</span>
<span class="fc" id="L450">			final Set&lt;AccountID&gt; applicantsAccountsIDs = new HashSet&lt;&gt;();</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">			for (final UUID uuid : applicantsAccountsUUIDs) {</span>
<span class="fc" id="L452">				applicantsAccountsIDs.add(new AccountID(uuid));</span>
			}

<span class="fc" id="L455">			final Map&lt;InterfaceID, InterfaceInContract&gt; interfacesInContract = new HashMap&lt;&gt;();</span>
<span class="fc" id="L456">			final List&lt;InterfaceInContract&gt; interfacesInContractSpecs = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L458">			final UUID[] interfacesInContractUUIDs = (UUID[]) rs.getArray(&quot;interfacesInContractValues&quot;).getArray();</span>
<span class="fc bfc" id="L459" title="All 2 branches covered.">			for (final UUID uuid : interfacesInContractUUIDs) {</span>
<span class="fc" id="L460">				final InterfaceInContract ifaceInContract = this.getInterfaceInContractByID(uuid);</span>
<span class="fc" id="L461">				interfacesInContractSpecs.add(ifaceInContract);</span>
<span class="fc" id="L462">				interfacesInContract.put(ifaceInContract.getInterfaceID(), ifaceInContract);</span>
			}

<span class="fc" id="L465">			result = new Contract();</span>
<span class="fc" id="L466">			result.setApplicantsAccountsIDs(applicantsAccountsIDs);</span>
<span class="fc" id="L467">			result.setBeginDate(beginDate);</span>
<span class="fc" id="L468">			result.setDataClayID(contractID);</span>
<span class="fc" id="L469">			result.setEndDate(endDate);</span>
<span class="fc" id="L470">			result.setInterfacesInContract(interfacesInContract);</span>
<span class="fc" id="L471">			result.setInterfacesInContractSpecs(interfacesInContractSpecs);</span>
<span class="fc" id="L472">			result.setNamespace(namespace);</span>
<span class="fc" id="L473">			result.setNamespaceID(namespaceID);</span>
<span class="fc" id="L474">			result.setProviderAccountID(providerAccountID);</span>
<span class="fc" id="L475">			result.setPublicAvailable(publicAvailable);</span>

<span class="nc" id="L477">		} catch (final SQLException e) {</span>
<span class="nc" id="L478">			e.printStackTrace();</span>
<span class="fc" id="L479">		}</span>
<span class="fc" id="L480">		return result;</span>
	}

	/**
	 * Get by ID
	 * @param uuid
	 *            UUID of object
	 * @return The object
	 * @throws SQLException
	 *             if not found
	 */
	private OpImplementations getOpImplementationsByID(final UUID uuid) throws SQLException {
<span class="fc" id="L492">		ResultSet rs = null;</span>
<span class="fc" id="L493">		OpImplementations result = null;</span>
<span class="fc" id="L494">		Connection conn = null;</span>
		try {
<span class="fc" id="L496">			conn = dataSource.getConnection();</span>
<span class="fc" id="L497">			final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_OPIMPLEMENTATIONS.getSqlStatement());</span>

<span class="fc" id="L499">			selectStatement.setObject(1, uuid);</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">			if (DEBUG_ENABLED) {</span>
<span class="nc" id="L501">				logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
			}
<span class="fc" id="L503">			rs = selectStatement.executeQuery();</span>
<span class="pc bpc" id="L504" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L505">				result = deserializeOpImplementations(rs);</span>

			}
<span class="fc" id="L508">			selectStatement.close();</span>
<span class="nc" id="L509">		} catch (final SQLException e) {</span>
<span class="nc" id="L510">			throw e;</span>
		} finally {
			try {
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">				if (conn != null) {</span>
<span class="fc" id="L514">					conn.close();</span>
				}
<span class="nc" id="L516">			} catch (final SQLException e) {</span>
<span class="nc" id="L517">				e.printStackTrace();</span>
<span class="fc" id="L518">			}</span>
		}

<span class="fc" id="L521">		return result;</span>
	}

	/**
	 * Get by ID
	 * @param uuid
	 *            UUID of object
	 * @return The object
	 * @throws SQLException
	 *             if not found
	 */
	private InterfaceInContract getInterfaceInContractByID(final UUID uuid) throws SQLException {
<span class="fc" id="L533">		ResultSet rs = null;</span>
<span class="fc" id="L534">		InterfaceInContract result = null;</span>
<span class="fc" id="L535">		Connection conn = null;</span>
		try {
<span class="fc" id="L537">			conn = dataSource.getConnection();</span>
<span class="fc" id="L538">			final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_IFACEINCONTRACT.getSqlStatement());</span>

<span class="fc" id="L540">			selectStatement.setObject(1, uuid);</span>
<span class="pc bpc" id="L541" title="1 of 2 branches missed.">			if (DEBUG_ENABLED) {</span>
<span class="nc" id="L542">				logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
			}
<span class="fc" id="L544">			rs = selectStatement.executeQuery();</span>
<span class="pc bpc" id="L545" title="1 of 2 branches missed.">			if (rs.next()) {</span>
<span class="fc" id="L546">				result = deserializeInterfaceInContract(rs);</span>

			}
<span class="fc" id="L549">			selectStatement.close();</span>

<span class="nc" id="L551">		} catch (final SQLException e) {</span>
<span class="nc" id="L552">			throw e;</span>
		} finally {
			try {
<span class="pc bpc" id="L555" title="1 of 2 branches missed.">				if (conn != null) {</span>
<span class="fc" id="L556">					conn.close();</span>
				}
<span class="nc" id="L558">			} catch (final SQLException e) {</span>
<span class="nc" id="L559">				e.printStackTrace();</span>
<span class="fc" id="L560">			}</span>
		}

<span class="fc" id="L563">		return result;</span>
	}

	/**
	 * Get by ID
	 * @param contractID
	 *            ID of object
	 * @return The object
	 * @throws SQLException
	 *             if not found
	 */
	public Contract getContractByID(final ContractID contractID) {
<span class="fc" id="L575">		synchronized (dataSource) {</span>
<span class="fc" id="L576">			ResultSet rs = null;</span>
<span class="fc" id="L577">			Contract result = null;</span>
<span class="fc" id="L578">			Connection conn = null;</span>
			try {
<span class="fc" id="L580">				conn = dataSource.getConnection();</span>
<span class="fc" id="L581">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_CONTRACT.getSqlStatement());</span>

<span class="fc" id="L583">				selectStatement.setObject(1, contractID.getId());</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L585">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L587">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L588" title="All 2 branches covered.">				if (rs.next()) {</span>
<span class="fc" id="L589">					result = deserializeContract(rs);</span>

				}
<span class="fc" id="L592">				selectStatement.close();</span>

<span class="nc" id="L594">			} catch (final SQLException e) {</span>
<span class="nc" id="L595">				throw new DbObjectNotExistException(contractID);</span>
			} finally {
				try {
<span class="pc bpc" id="L598" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L599">						conn.close();</span>
					}
<span class="nc" id="L601">				} catch (final SQLException e) {</span>
<span class="nc" id="L602">					e.printStackTrace();</span>
<span class="fc" id="L603">				}</span>
			}

<span class="fc" id="L606">			return result;</span>
		}
	}

	/**
	 * Delete by ID
	 * @param uuid
	 *            UUID of object
	 * 
	 */
	private void deleteOpImplementationsByID(final UUID uuid) {
<span class="nc" id="L617">		Connection conn = null;</span>
		try {
<span class="nc" id="L619">			conn = dataSource.getConnection();</span>
<span class="nc" id="L620">			final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.DELETE_OPIMPLEMENTATIONS.getSqlStatement());</span>

<span class="nc" id="L622">			selectStatement.setObject(1, uuid);</span>
<span class="nc bnc" id="L623" title="All 2 branches missed.">			if (DEBUG_ENABLED) {</span>
<span class="nc" id="L624">				logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
			}
<span class="nc" id="L626">			selectStatement.executeUpdate();</span>
<span class="nc" id="L627">			selectStatement.close();</span>

<span class="nc" id="L629">		} catch (final SQLException e) {</span>
			// not found, ignore
			// e.printStackTrace();
		} finally {
			try {
<span class="nc bnc" id="L634" title="All 2 branches missed.">				if (conn != null) {</span>
<span class="nc" id="L635">					conn.close();</span>
				}
<span class="nc" id="L637">			} catch (final SQLException e) {</span>
<span class="nc" id="L638">				e.printStackTrace();</span>
<span class="nc" id="L639">			}</span>
		}

<span class="nc" id="L642">	}</span>

	/**
	 * Delete by ID
	 * @param uuid
	 *            UUID of object
	 */
	private void deleteInterfaceInContractByID(final UUID uuid) {

		final InterfaceInContract ifaceInContract;
		try {
<span class="nc" id="L653">			ifaceInContract = this.getInterfaceInContractByID(uuid);</span>
<span class="nc bnc" id="L654" title="All 2 branches missed.">			for (final OpImplementations opImpl : ifaceInContract.getAccessibleImplementations().values()) {</span>
<span class="nc" id="L655">				this.deleteOpImplementationsByID(opImpl.getId());</span>
<span class="nc" id="L656">			}</span>
<span class="nc bnc" id="L657" title="All 2 branches missed.">			for (final OpImplementations opImpl : ifaceInContract.getImplementationsSpecPerOperation()) {</span>
<span class="nc" id="L658">				this.deleteOpImplementationsByID(opImpl.getId());</span>
<span class="nc" id="L659">			}</span>

<span class="nc" id="L661">		} catch (final SQLException e1) {</span>
<span class="nc" id="L662">			e1.printStackTrace();</span>
<span class="nc" id="L663">		}</span>

<span class="nc" id="L665">		Connection conn = null;</span>
		try {
<span class="nc" id="L667">			conn = dataSource.getConnection();</span>
<span class="nc" id="L668">			final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.DELETE_IFACEINCONTRACT.getSqlStatement());</span>

<span class="nc" id="L670">			selectStatement.setObject(1, uuid);</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">			if (DEBUG_ENABLED) {</span>
<span class="nc" id="L672">				logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
			}
<span class="nc" id="L674">			selectStatement.executeUpdate();</span>
<span class="nc" id="L675">			selectStatement.close();</span>

<span class="nc" id="L677">		} catch (final SQLException e) {</span>
			// not found, ignore
			// e.printStackTrace();
		} finally {
			try {
<span class="nc bnc" id="L682" title="All 2 branches missed.">				if (conn != null) {</span>
<span class="nc" id="L683">					conn.close();</span>
				}
<span class="nc" id="L685">			} catch (final SQLException e) {</span>
<span class="nc" id="L686">				e.printStackTrace();</span>
<span class="nc" id="L687">			}</span>
		}

<span class="nc" id="L690">	}</span>

	/**
	 * Delete by ID
	 * @param contractID
	 *            ID of object
	 */
	public void deleteContractByID(final ContractID contractID) {
<span class="nc" id="L698">		synchronized (dataSource) {</span>
<span class="nc" id="L699">			final Contract contract = this.getContractByID(contractID);</span>
<span class="nc bnc" id="L700" title="All 2 branches missed.">			for (final InterfaceInContract ifaceInContract : contract.getInterfacesInContractSpecs()) {</span>
<span class="nc" id="L701">				this.deleteInterfaceInContractByID(ifaceInContract.getId());</span>
<span class="nc" id="L702">			}</span>

<span class="nc" id="L704">			Connection conn = null;</span>
			try {
<span class="nc" id="L706">				conn = dataSource.getConnection();</span>
<span class="nc" id="L707">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.DELETE_CONTRACT.getSqlStatement());</span>

<span class="nc" id="L709">				selectStatement.setObject(1, contractID.getId());</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L711">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="nc" id="L713">				selectStatement.executeUpdate();</span>
<span class="nc" id="L714">				selectStatement.close();</span>

<span class="nc" id="L716">			} catch (final SQLException e) {</span>
				// not found, ignore
				// e.printStackTrace();
			} finally {
				try {
<span class="nc bnc" id="L721" title="All 2 branches missed.">					if (conn != null) {</span>
<span class="nc" id="L722">						conn.close();</span>
					}
<span class="nc" id="L724">				} catch (final SQLException e) {</span>
<span class="nc" id="L725">					e.printStackTrace();</span>
<span class="nc" id="L726">				}</span>
			}
<span class="nc" id="L728">		}</span>
<span class="nc" id="L729">	}</span>

	/**
	 * Update by ID
	 * @param contractID
	 *            ID of object
	 */
	public void updateContractsAddApplicant(final ContractID contractID, final AccountID applicantAccountID) {
<span class="fc" id="L737">		synchronized (dataSource) {</span>
<span class="fc" id="L738">			Connection conn = null;</span>
			try {
<span class="fc" id="L740">				conn = dataSource.getConnection();</span>
<span class="fc" id="L741">				final PreparedStatement stmt = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.UPDATE_CONTRACT_ADD_APPLICANT.getSqlStatement());</span>
<span class="fc" id="L742">				stmt.setObject(1, applicantAccountID.getId());</span>
<span class="fc" id="L743">				stmt.setObject(2, contractID.getId());</span>
<span class="pc bpc" id="L744" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L745">					logger.debug(&quot;[==DB==] Executing &quot; + stmt);</span>
				}
<span class="fc" id="L747">				stmt.executeUpdate();</span>
<span class="fc" id="L748">				stmt.close();</span>

<span class="nc" id="L750">			} catch (final SQLException e) {</span>
				// not found, ignore
				// e.printStackTrace();
			} finally {
				try {
<span class="pc bpc" id="L755" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L756">						conn.close();</span>
					}
<span class="nc" id="L758">				} catch (final SQLException e) {</span>
<span class="nc" id="L759">					e.printStackTrace();</span>
<span class="fc" id="L760">				}</span>
			}
<span class="fc" id="L762">		}</span>
<span class="fc" id="L763">	}</span>

	/**
	 * Get contracts of namespace
	 * @param namespaceID
	 *            contracts ID
	 * @return The Contracts
	 */
	public List&lt;Contract&gt; getContractsOfNamespace(final NamespaceID namespaceID) {
<span class="fc" id="L772">		synchronized (dataSource) {</span>
<span class="fc" id="L773">			ResultSet rs = null;</span>
<span class="fc" id="L774">			final List&lt;Contract&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L775">			Connection conn = null;</span>
			try {
<span class="fc" id="L777">				conn = dataSource.getConnection();</span>
<span class="fc" id="L778">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_CONTRACTS_OF_NAMESPACE.getSqlStatement());</span>
<span class="fc" id="L779">				selectStatement.setObject(1, namespaceID.getId());</span>
<span class="pc bpc" id="L780" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L781">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L783">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L784" title="All 2 branches covered.">				while (rs.next()) {</span>
<span class="fc" id="L785">					result.add(deserializeContract(rs));</span>
				}
<span class="fc" id="L787">				selectStatement.close();</span>

<span class="nc" id="L789">			} catch (final SQLException e) {</span>
<span class="nc" id="L790">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L793" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L794">						conn.close();</span>
					}
<span class="nc" id="L796">				} catch (final SQLException e) {</span>
<span class="nc" id="L797">					e.printStackTrace();</span>
<span class="fc" id="L798">				}</span>
			}

<span class="fc" id="L801">			return result;</span>
		}
	}

	/**
	 * Get contracts containing interface
	 * @param interfaceID
	 *            interface ID
	 * @return The Contracts
	 */
	public List&lt;Contract&gt; getContractsContainingInterface(final InterfaceID interfaceID) {
<span class="fc" id="L812">		synchronized (dataSource) {</span>
<span class="fc" id="L813">			ResultSet rs = null;</span>
<span class="fc" id="L814">			final List&lt;Contract&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L815">			Connection conn = null;</span>
			try {
<span class="fc" id="L817">				conn = dataSource.getConnection();</span>
<span class="fc" id="L818">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_CONTRACTS_WITH_INTERFACE.getSqlStatement());</span>

<span class="fc" id="L820">				final Array tArray = selectStatement.getConnection().createArrayOf(&quot;uuid&quot;, new UUID[]{interfaceID.getId()});</span>
<span class="fc" id="L821">				selectStatement.setArray(1, tArray);</span>

<span class="pc bpc" id="L823" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L824">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L826">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L827" title="All 2 branches covered.">				while (rs.next()) {</span>
<span class="fc" id="L828">					result.add(deserializeContract(rs));</span>
				}
<span class="fc" id="L830">				selectStatement.close();</span>

<span class="nc" id="L832">			} catch (final SQLException e) {</span>
<span class="nc" id="L833">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L836" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L837">						conn.close();</span>
					}
<span class="nc" id="L839">				} catch (final SQLException e) {</span>
<span class="nc" id="L840">					e.printStackTrace();</span>
<span class="fc" id="L841">				}</span>
			}

<span class="fc" id="L844">			return result;</span>
		}
	}

	/**
	 * Get contracts containing applicant
	 * @param applicantAccountID
	 *            Account ID
	 * @return The Contracts
	 */
	public List&lt;Contract&gt; getContractsWithApplicant(final AccountID applicantAccountID) {
<span class="fc" id="L855">		synchronized (dataSource) {</span>
<span class="fc" id="L856">			ResultSet rs = null;</span>
<span class="fc" id="L857">			final List&lt;Contract&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L858">			Connection conn = null;</span>
			try {
<span class="fc" id="L860">				conn = dataSource.getConnection();</span>
<span class="fc" id="L861">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_CONTRACTS_WITH_APPLICANT.getSqlStatement());</span>
<span class="fc" id="L862">				final Array tArray = selectStatement.getConnection().createArrayOf(&quot;uuid&quot;, new UUID[]{applicantAccountID.getId()});</span>
<span class="fc" id="L863">				selectStatement.setArray(1, tArray);</span>

<span class="pc bpc" id="L865" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L866">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L868">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L869" title="All 2 branches covered.">				while (rs.next()) {</span>
<span class="fc" id="L870">					result.add(deserializeContract(rs));</span>
				}
<span class="fc" id="L872">				selectStatement.close();</span>
<span class="nc" id="L873">			} catch (final SQLException e) {</span>
<span class="nc" id="L874">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L877" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L878">						conn.close();</span>
					}
<span class="nc" id="L880">				} catch (final SQLException e) {</span>
<span class="nc" id="L881">					e.printStackTrace();</span>
<span class="fc" id="L882">				}</span>
			}

<span class="fc" id="L885">			return result;</span>
		}
	}

	/**
	 * Get contracts containing provider
	 * @param providerAccountID
	 *            Account ID
	 * @return The Contracts
	 */
	public List&lt;Contract&gt; getContractsWithProvider(final AccountID providerAccountID) {
<span class="nc" id="L896">		synchronized (dataSource) {</span>
<span class="nc" id="L897">			ResultSet rs = null;</span>
<span class="nc" id="L898">			final List&lt;Contract&gt; result = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L899">			Connection conn = null;</span>
			try {
<span class="nc" id="L901">				conn = dataSource.getConnection();</span>
<span class="nc" id="L902">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_CONTRACTS_WITH_PROVIDER.getSqlStatement());</span>
<span class="nc" id="L903">				selectStatement.setObject(1, providerAccountID.getId());</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L905">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="nc" id="L907">				rs = selectStatement.executeQuery();</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L909">					result.add(deserializeContract(rs));</span>
				}
<span class="nc" id="L911">				selectStatement.close();</span>

<span class="nc" id="L913">			} catch (final SQLException e) {</span>
<span class="nc" id="L914">				e.printStackTrace();</span>
			} finally {
				try {
<span class="nc bnc" id="L917" title="All 2 branches missed.">					if (conn != null) {</span>
<span class="nc" id="L918">						conn.close();</span>
					}
<span class="nc" id="L920">				} catch (final SQLException e) {</span>
<span class="nc" id="L921">					e.printStackTrace();</span>
<span class="nc" id="L922">				}</span>
			}

<span class="nc" id="L925">			return result;</span>
		}
	}

	/**
	 * Get OpImplementations with implementation id
	 * @param implementationID
	 *            ID of implementation
	 * @return The OpImplementations
	 */
	public List&lt;OpImplementations&gt; getOpImplementationsWithImpl(final ImplementationID implementationID) {
<span class="fc" id="L936">		synchronized (dataSource) {</span>
<span class="fc" id="L937">			ResultSet rs = null;</span>
<span class="fc" id="L938">			final List&lt;OpImplementations&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L939">			Connection conn = null;</span>
			try {
<span class="fc" id="L941">				conn = dataSource.getConnection();</span>
<span class="fc" id="L942">				final PreparedStatement selectStatement = conn.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_OPIMPLS_WITH_IMPL.getSqlStatement());</span>
<span class="fc" id="L943">				selectStatement.setObject(1, implementationID.getId());</span>
<span class="fc" id="L944">				selectStatement.setObject(2, implementationID.getId());</span>
<span class="pc bpc" id="L945" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L946">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L948">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L949" title="All 2 branches covered.">				while (rs.next()) {</span>
<span class="fc" id="L950">					result.add(deserializeOpImplementations(rs));</span>
				}
<span class="fc" id="L952">				selectStatement.close();</span>

<span class="nc" id="L954">			} catch (final SQLException e) {</span>
<span class="nc" id="L955">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L958" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L959">						conn.close();</span>
					}
<span class="nc" id="L961">				} catch (final SQLException e) {</span>
<span class="nc" id="L962">					e.printStackTrace();</span>
<span class="fc" id="L963">				}</span>
			}

<span class="fc" id="L966">			return result;</span>
		}
	}

	/**
	 * Get contracts containing applicant and namespace
	 * @param applicantAccountID
	 *            Account ID
	 * @param namespaceID
	 *            ID of namespace
	 * @return The Contracts
	 */
	public List&lt;Contract&gt; getContractsWithApplicantAndNamespace(final AccountID applicantAccountID,
			final NamespaceID namespaceID) {
<span class="fc" id="L980">		synchronized (dataSource) {</span>
<span class="fc" id="L981">			ResultSet rs = null;</span>
<span class="fc" id="L982">			final List&lt;Contract&gt; result = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L983">			Connection conn = null;</span>
			try {
<span class="fc" id="L985">				conn = dataSource.getConnection();</span>
<span class="fc" id="L986">				final PreparedStatement selectStatement = conn</span>
<span class="fc" id="L987">						.prepareStatement(ContractManagerSQLStatements.SqlStatements.SELECT_ALL_CONTRACTS_WITH_APPLICANT_AND_NAMESPACE.getSqlStatement());</span>
<span class="fc" id="L988">				final Array tArray = selectStatement.getConnection().createArrayOf(&quot;uuid&quot;, new UUID[]{applicantAccountID.getId()});</span>
<span class="fc" id="L989">				selectStatement.setArray(1, tArray);</span>
<span class="fc" id="L990">				selectStatement.setObject(2, namespaceID.getId());</span>
<span class="pc bpc" id="L991" title="1 of 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L992">					logger.debug(&quot;[==DB==] Executing &quot; + selectStatement);</span>
				}
<span class="fc" id="L994">				rs = selectStatement.executeQuery();</span>
<span class="fc bfc" id="L995" title="All 2 branches covered.">				while (rs.next()) {</span>
<span class="fc" id="L996">					result.add(deserializeContract(rs));</span>
				}
<span class="fc" id="L998">				selectStatement.close();</span>

<span class="nc" id="L1000">			} catch (final SQLException e) {</span>
<span class="nc" id="L1001">				e.printStackTrace();</span>
			} finally {
				try {
<span class="pc bpc" id="L1004" title="1 of 2 branches missed.">					if (conn != null) {</span>
<span class="fc" id="L1005">						conn.close();</span>
					}
<span class="nc" id="L1007">				} catch (final SQLException e) {</span>
<span class="nc" id="L1008">					e.printStackTrace();</span>
<span class="fc" id="L1009">				}</span>
			}

<span class="fc" id="L1012">			return result;</span>
		}
	}

	/**
	 * Close DB.
	 */
	public void close() {
		try {
<span class="fc" id="L1021">			dataSource.close();</span>
<span class="nc" id="L1022">		}catch(Exception e) {</span>
			// TODO
<span class="nc" id="L1024">			e.printStackTrace();</span>
<span class="fc" id="L1025">		}</span>
<span class="fc" id="L1026">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>