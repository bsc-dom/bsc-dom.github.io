<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Utils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">dataclay</a> &gt; <a href="index.source.html" class="el_package">es.bsc.dataclay.communication.grpc</a> &gt; <span class="el_source">Utils.java</span></div><h1>Utils.java</h1><pre class="source lang-java linenums">
/**
 * 
 */
package es.bsc.dataclay.communication.grpc;

import java.io.ByteArrayOutputStream;
import java.io.PrintStream;
import java.util.*;
import java.util.Map.Entry;
import java.util.concurrent.ConcurrentHashMap;

import es.bsc.dataclay.util.ids.*;
import es.bsc.dataclay.util.management.metadataservice.*;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import com.google.protobuf.ByteString;
import com.google.protobuf.Descriptors.FieldDescriptor;

import es.bsc.dataclay.communication.grpc.messages.common.CommonMessages;
import es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.ExceptionInfo;
import es.bsc.dataclay.exceptions.DataClayException;
import es.bsc.dataclay.serialization.buffer.DataClayByteArray;
import es.bsc.dataclay.serialization.buffer.DataClayByteBuffer;
import es.bsc.dataclay.serialization.lib.DataClayDeserializationLib;
import es.bsc.dataclay.serialization.lib.ImmutableParamOrReturn;
import es.bsc.dataclay.serialization.lib.LanguageParamOrReturn;
import es.bsc.dataclay.serialization.lib.ObjectWithDataParamOrReturn;
import es.bsc.dataclay.serialization.lib.PersistentParamOrReturn;
import es.bsc.dataclay.serialization.lib.SerializationLibUtils;
import es.bsc.dataclay.serialization.lib.SerializedParametersOrReturn;
import es.bsc.dataclay.util.Configuration;
import es.bsc.dataclay.util.DataClayObjectMetaData;
import es.bsc.dataclay.util.management.accountmgr.PasswordCredential;

import com.google.protobuf.MapEntry;

/**
 * Utility class for communication.
 */
public final class Utils {

	/** Logger. */
<span class="nc" id="L45">	private static final Logger LOGGER = LogManager.getLogger(&quot;exceptions&quot;);</span>

	/** Indicates if debug is enabled. */
<span class="nc" id="L48">	protected static final boolean DEBUG_ENABLED = Configuration.isDebugEnabled();</span>

	/**
	 * Utility classes should have private constructor.
	 */
	private Utils() {

	}

	/**
	 * Get string representation of ID
	 * @param id ID to get representation from
	 * @return String represation or null if id is null
	 */
	public static String getMsgID(final ID id) {
<span class="nc bnc" id="L63" title="All 2 branches missed.">		if (id == null) {</span>
<span class="nc" id="L64">			return &quot;&quot;;</span>
		} else {
<span class="nc" id="L66">			return id.toString();</span>
		}
	}

	/**
	 * Get password credential
	 * 
	 * @param cred
	 *            Credential
	 * @return Password credential
	 */
	public static PasswordCredential getCredential(
			final es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.Credential cred) {
<span class="nc bnc" id="L79" title="All 2 branches missed.">		if (cred == null || cred</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">				.equals(es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.Credential.getDefaultInstance())) {</span>
<span class="nc" id="L81">			return null;</span>
		} else {
<span class="nc" id="L83">			return new PasswordCredential(cred.getPassword());</span>
		}
	}


	/**
	 * Get AccountID ID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return AccountID
	 */
	public static AccountID getAccountID(final String idMsg) {
<span class="nc bnc" id="L96" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L97">			return null;</span>
		} else {
<span class="nc" id="L99">			return new AccountID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ContractID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ContractID
	 */
	public static ContractID getContractID(final String idMsg) {
<span class="nc bnc" id="L111" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L112">			return null;</span>
		} else {
<span class="nc" id="L114">			return new ContractID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get CredentialID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return CredentialID
	 */
	public static CredentialID getCredentialID(String idMsg) {
<span class="nc bnc" id="L126" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L127">			return null;</span>
		} else {
<span class="nc" id="L129">			return new CredentialID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get DataContractID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return DataContractID
	 */
	public static DataContractID getDataContractID(String idMsg) {
<span class="nc bnc" id="L141" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L142">			return null;</span>
		} else {
<span class="nc" id="L144">			return new DataContractID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get DataSetID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return DataSetID
	 */
	public static DataSetID getDataSetID(final String idMsg) {
<span class="nc bnc" id="L156" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L157">			return null;</span>
		} else {
<span class="nc" id="L159">			return new DataSetID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get NamespaceID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return NamespaceID
	 */
	public static NamespaceID getNamespaceID(final String idMsg) {
<span class="nc bnc" id="L171" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L172">			return null;</span>
		} else {
<span class="nc" id="L174">			return new NamespaceID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ECAID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ECAID
	 */
	public static ECAID getECAID(final String idMsg) {
<span class="nc bnc" id="L186" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L187">			return null;</span>
		} else {
<span class="nc" id="L189">			return new ECAID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get EventMessageID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return EventMessageID
	 */
	public static EventMessageID getEventMessageID(final String idMsg) {
<span class="nc bnc" id="L201" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L202">			return null;</span>
		} else {
<span class="nc" id="L204">			return new EventMessageID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get EventObjsMeetConditionID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return EventObjsMeetConditionID
	 */
	public static EventObjsMeetConditionID getEventObjsMeetConditionID(String idMsg) {
<span class="nc bnc" id="L216" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L217">			return null;</span>
		} else {
<span class="nc" id="L219">			return new EventObjsMeetConditionID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ExecutionEnvironmentID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ExecutionEnvironmentID
	 */
	public static ExecutionEnvironmentID getExecutionEnvironmentID(String idMsg) {
<span class="nc bnc" id="L231" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L232">			return null;</span>
		} else {
<span class="nc" id="L234">			return new ExecutionEnvironmentID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ImplementationID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ImplementationID
	 */
	public static ImplementationID getImplementationID(String idMsg) {
<span class="nc bnc" id="L246" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L247">			return null;</span>
		} else {
<span class="nc" id="L249">			return new ImplementationID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get InterfaceID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return InterfaceID
	 */
	public static InterfaceID getInterfaceID(String idMsg) {
<span class="nc bnc" id="L261" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L262">			return null;</span>
		} else {
<span class="nc" id="L264">			return new InterfaceID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get MetaClassID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return MetaClassID
	 */
	public static MetaClassID getMetaClassID(String idMsg) {
<span class="nc bnc" id="L276" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L277">			return null;</span>
		} else {
<span class="nc" id="L279">			return new MetaClassID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ObjectID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ObjectID
	 */
	public static ObjectID getObjectID(final String idMsg) {
<span class="nc bnc" id="L291" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L292">			return null;</span>
		} else {
<span class="nc" id="L294">			return new ObjectID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get OperationID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return OperationID
	 */
	public static OperationID getOperationID(String idMsg) {
<span class="nc bnc" id="L306" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L307">			return null;</span>
		} else {
<span class="nc" id="L309">			return new OperationID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get PropertyID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return PropertyID
	 */
	public static PropertyID getPropertyID(final String idMsg) {
<span class="nc bnc" id="L321" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L322">			return null;</span>
		} else {
<span class="nc" id="L324">			return new PropertyID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get QualitativeRegistryID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return QualitativeRegistryID
	 */
	public static QualitativeRegistryID getQualitativeRegistryID(String idMsg) {
<span class="nc bnc" id="L336" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L337">			return null;</span>
		} else {
<span class="nc" id="L339">			return new QualitativeRegistryID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get ResourceID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return ResourceID
	 */
	public static ResourceID getResourceID(final String idMsg) {
<span class="nc bnc" id="L351" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L352">			return null;</span>
		} else {
<span class="nc" id="L354">			return new ResourceID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get SessionID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return SessionID
	 */
	public static SessionID getSessionID(final String idMsg) {
<span class="nc bnc" id="L366" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L367">			return null;</span>
		} else {
<span class="nc" id="L369">			return new SessionID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get StorageLocationID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return StorageLocationID
	 */
	public static StorageLocationID getStorageLocationID(String idMsg) {
<span class="nc bnc" id="L381" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L382">			return null;</span>
		} else {
<span class="nc" id="L384">			return new StorageLocationID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get DataClayID from Protobuf ID
	 * 
	 * @param idMsg
	 *            Message ID
	 * @return DataClayID
	 */
	public static DataClayInstanceID getDataClayInstanceID(String idMsg) {
<span class="nc bnc" id="L396" title="All 4 branches missed.">		if (idMsg == null || idMsg.isEmpty()) {</span>
<span class="nc" id="L397">			return null;</span>
		} else {
<span class="nc" id="L399">			return new DataClayInstanceID(UUID.fromString(idMsg));</span>
		}
	}

	/**
	 * Get password credential
	 * 
	 * @param cred
	 *            Credential
	 * @return Password credential
	 */
	public static es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.Credential getCredential(
			final PasswordCredential cred) {
<span class="nc bnc" id="L412" title="All 2 branches missed.">		if (cred == null) {</span>
<span class="nc" id="L413">			return es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.Credential.getDefaultInstance();</span>
		} else {
<span class="nc" id="L415">			return es.bsc.dataclay.communication.grpc.messages.common.CommonMessages.Credential.newBuilder()</span>
<span class="nc" id="L416">					.setPassword(cred.getPassword()).build();</span>
		}
	}

	/**
	 * Return ExceptionInfo message
	 * 
	 * @param responseObserver
	 *            Observer
	 */
	public static void returnExceptionInfoMessage(final io.grpc.stub.StreamObserver&lt;ExceptionInfo&gt; responseObserver) {
<span class="nc" id="L427">		final ExceptionInfo resp = ExceptionInfo.newBuilder().build();</span>
<span class="nc" id="L428">		responseObserver.onNext(resp);</span>
<span class="nc" id="L429">	}</span>

	/**
	 * Get MetaData GRPC message from DataClayMetaData
	 * 
	 * @param metadata
	 *            DataClayMetaData
	 * @return MetaData GRPC message
	 */
	public static CommonMessages.DataClayObjectMetaData getMetaData(final DataClayObjectMetaData metadata) {
		final CommonMessages.DataClayObjectMetaData.Builder metadataBuilder = CommonMessages.DataClayObjectMetaData
<span class="nc" id="L440">				.newBuilder();</span>

<span class="nc bnc" id="L442" title="All 2 branches missed.">		if (metadata.getOids() != null) {</span>
<span class="nc bnc" id="L443" title="All 2 branches missed.">			for (final Entry&lt;Integer, ObjectID&gt; oidEntry : metadata.getOids().entrySet()) {</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">				if (oidEntry.getValue() != null) {</span>
<span class="nc" id="L445">					final String oidIDmsg = Utils.getMsgID(oidEntry.getValue());</span>
<span class="nc" id="L446">					metadataBuilder.putOids(oidEntry.getKey(), oidIDmsg);</span>
					// System.err.println(&quot;OID entry bytes = &quot; + Reflector.bytesToHex(
					// oidIDmsg.toByteArray()));
				}
<span class="nc" id="L450">			}</span>
		}

<span class="nc bnc" id="L453" title="All 2 branches missed.">		if (metadata.getClassIDs() != null) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">			for (final Entry&lt;Integer, MetaClassID&gt; classIDEntry : metadata.getClassIDs().entrySet()) {</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">				if (classIDEntry.getValue() != null) {</span>
<span class="nc" id="L456">					final String classIDmsg = Utils.getMsgID(classIDEntry.getValue());</span>
<span class="nc" id="L457">					metadataBuilder.putClassids(classIDEntry.getKey(), classIDmsg);</span>
					// System.err.println(&quot;ClassID entry bytes = &quot; + Reflector.bytesToHex(
					// classIDmsg.toByteArray()));
				}
<span class="nc" id="L461">			}</span>
		}

<span class="nc bnc" id="L464" title="All 2 branches missed.">		if (metadata.getHints() != null) {</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">			for (final Entry&lt;Integer, ExecutionEnvironmentID&gt; hintEntry : metadata.getHints().entrySet()) {</span>
<span class="nc bnc" id="L466" title="All 4 branches missed.">				if (hintEntry.getKey() != null &amp;&amp; hintEntry.getValue() != null) {</span>
<span class="nc" id="L467">					metadataBuilder.putHints(hintEntry.getKey(), Utils.getMsgID(hintEntry.getValue()));</span>
				}
<span class="nc" id="L469">			}</span>
		}
<span class="nc bnc" id="L471" title="All 2 branches missed.">		if (metadata.getReplicaLocations() != null) {</span>
<span class="nc bnc" id="L472" title="All 2 branches missed.">			for (final ExecutionEnvironmentID loc : metadata.getReplicaLocations()) {</span>
<span class="nc bnc" id="L473" title="All 2 branches missed.">				if (loc != null) {</span>
<span class="nc" id="L474">					metadataBuilder.addReplicaLocations(Utils.getMsgID(loc));</span>
				}
<span class="nc" id="L476">			}</span>
		}
<span class="nc bnc" id="L478" title="All 2 branches missed.">		if (metadata.getAlias() != null) {</span>
<span class="nc" id="L479">			metadataBuilder.setAlias(metadata.getAlias());</span>
		}
<span class="nc" id="L481">		metadataBuilder.setRootLocation(Utils.getMsgID(metadata.getRootLocation()));</span>
<span class="nc" id="L482">		metadataBuilder.setOriginLocation(Utils.getMsgID(metadata.getOriginLocation()));</span>
<span class="nc" id="L483">		metadataBuilder.setIsReadOnly(metadata.getIsReadOnly());</span>
<span class="nc" id="L484">		metadataBuilder.setOrigObjectID(Utils.getMsgID(metadata.getOriginalObjectID()));</span>
<span class="nc" id="L485">		metadataBuilder.setNumRefs(metadata.getNumRefs());</span>
<span class="nc" id="L486">		return metadataBuilder.build();</span>

	}

	/**
	 * Retrieve the metadata from the specified msg object
	 * 
	 * @param msg
	 *            a message with metadata of a certain object
	 * @return the metadata included within the message
	 */
	public static DataClayObjectMetaData getMetaData(final CommonMessages.DataClayObjectMetaData msg) {
<span class="nc" id="L498">		final Map&lt;Integer, MetaClassID&gt; classIDs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L499">		final Map&lt;Integer, ObjectID&gt; oids = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L500">		final Map&lt;Integer, ExecutionEnvironmentID&gt; hints = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L501">		final Map&lt;Integer, DataClayInstanceID&gt; extDataClayIDs = new ConcurrentHashMap&lt;&gt;();</span>

<span class="nc bnc" id="L503" title="All 2 branches missed.">		if (msg.getClassidsMap() != null) {</span>
<span class="nc bnc" id="L504" title="All 2 branches missed.">			for (final Entry&lt;Integer, String&gt; classIDEntry : msg.getClassidsMap().entrySet()) {</span>
<span class="nc bnc" id="L505" title="All 4 branches missed.">				if (classIDEntry.getKey() != null &amp;&amp; classIDEntry.getValue() != null) {</span>
<span class="nc" id="L506">					final MetaClassID classID = Utils.getMetaClassID(classIDEntry.getValue());</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">					if (classID != null) {</span>
<span class="nc" id="L508">						classIDs.put(classIDEntry.getKey(), classID);</span>
					}
				}
<span class="nc" id="L511">			}</span>
		}

<span class="nc bnc" id="L514" title="All 2 branches missed.">		if (msg.getOidsMap() != null) {</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">			for (final Entry&lt;Integer, String&gt; entry : msg.getOidsMap().entrySet()) {</span>
<span class="nc bnc" id="L516" title="All 4 branches missed.">				if (entry.getKey() != null &amp;&amp; entry.getValue() != null) {</span>
<span class="nc" id="L517">					oids.put(entry.getKey(), Utils.getObjectID(entry.getValue()));</span>
				}
<span class="nc" id="L519">			}</span>
		}

<span class="nc bnc" id="L522" title="All 2 branches missed.">		if (msg.getHintsMap() != null) {</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">			for (final Entry&lt;Integer, String&gt; entry : msg.getHintsMap().entrySet()) {</span>
<span class="nc bnc" id="L524" title="All 4 branches missed.">				if (entry.getKey() != null &amp;&amp; entry.getValue() != null) {</span>
<span class="nc" id="L525">					hints.put(entry.getKey(), Utils.getExecutionEnvironmentID(entry.getValue()));</span>
				}
<span class="nc" id="L527">			}</span>
		}

<span class="nc" id="L530">		final int numRefs = msg.getNumRefs();</span>
<span class="nc" id="L531">		final ObjectID origObjectID = Utils.getObjectID(msg.getOrigObjectID());</span>
<span class="nc" id="L532">		final ExecutionEnvironmentID rootLocation = Utils.getExecutionEnvironmentID(msg.getRootLocation());</span>
<span class="nc" id="L533">		final ExecutionEnvironmentID origLocation = Utils.getExecutionEnvironmentID(msg.getOriginLocation());</span>
<span class="nc" id="L534">		final Set&lt;ExecutionEnvironmentID&gt; replicaLocations = ConcurrentHashMap.newKeySet();</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">		for (String eeID : msg.getReplicaLocationsList()) {</span>
<span class="nc" id="L536">			replicaLocations.add(Utils.getExecutionEnvironmentID(eeID));</span>
<span class="nc" id="L537">		}</span>


<span class="nc" id="L540">		return new DataClayObjectMetaData(msg.getAlias(), msg.getIsReadOnly(), oids, classIDs, hints, numRefs,</span>
				origObjectID, rootLocation, origLocation, replicaLocations);

	}

	/**
	 * Return a message for GRPC call
	 *
	 * @param object object to convert
	 * @return the resulting message
	 */
	public static CommonMessages.MetaDataInfo getMetaDataInfo(
			final MetaDataInfo object) {
<span class="nc bnc" id="L553" title="All 2 branches missed.">		if (object == null) {</span>
<span class="nc" id="L554">			return CommonMessages.MetaDataInfo.getDefaultInstance();</span>
		}
<span class="nc" id="L556">		CommonMessages.MetaDataInfo.Builder builder = CommonMessages.MetaDataInfo.newBuilder();</span>
<span class="nc" id="L557">		builder.setObjectID(Utils.getMsgID(object.getDataClayID()));</span>
<span class="nc" id="L558">		builder.setIsReadOnly(object.getIsReadOnly());</span>
<span class="nc" id="L559">		builder.setDatasetID(Utils.getMsgID(object.getDatasetID()));</span>
<span class="nc" id="L560">		builder.setMetaclassID(Utils.getMsgID(object.getMetaclassID()));</span>
<span class="nc" id="L561">		builder.setOwnerID(Utils.getMsgID(object.getOwnerID()));</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">		if (object.getAlias() != null) {</span>
<span class="nc" id="L563">			builder.setAlias(object.getAlias());</span>
		}
<span class="nc bnc" id="L565" title="All 2 branches missed.">		for (ExecutionEnvironmentID loc : object.getLocations()) {</span>
<span class="nc" id="L566">			builder.addLocations(Utils.getMsgID(loc));</span>
<span class="nc" id="L567">		}</span>
<span class="nc" id="L568">		return builder.build();</span>
	}

	/**
	 * Return an object FROM grpc message
	 *
	 * @param msg object to convert
	 * @return the resulting object
	 */
	public static MetaDataInfo getMetaDataInfo(
			final CommonMessages.MetaDataInfo msg) {

<span class="nc bnc" id="L580" title="All 2 branches missed.">		if (msg.equals(CommonMessages.MetaDataInfo.getDefaultInstance())) {</span>
<span class="nc" id="L581">			return null;</span>
		}

<span class="nc" id="L584">		Set&lt;ExecutionEnvironmentID&gt; locs = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">		for (String eeID : msg.getLocationsList()) {</span>
<span class="nc" id="L586">			locs.add(Utils.getExecutionEnvironmentID(eeID));</span>
<span class="nc" id="L587">		}</span>
<span class="nc" id="L588">		MetaDataInfo mdInfo = new MetaDataInfo(</span>
<span class="nc" id="L589">				Utils.getObjectID(msg.getObjectID()),</span>
<span class="nc" id="L590">				Utils.getDataSetID(msg.getDatasetID()),</span>
<span class="nc" id="L591">				Utils.getMetaClassID(msg.getMetaclassID()),</span>
<span class="nc" id="L592">				msg.getIsReadOnly(),</span>
<span class="nc" id="L593">				locs, msg.getAlias(), Utils.getAccountID(msg.getOwnerID()));</span>
<span class="nc" id="L594">		return mdInfo;</span>
	}

	/**
	 * Return a message for GRPC call
	 *
	 * @param object object to convert
	 * @return the resulting message
	 */
	public static CommonMessages.ExecutionEnvironmentInfo getExecutionEnvironment(
			final ExecutionEnvironment object) {
<span class="nc" id="L605">		CommonMessages.ExecutionEnvironmentInfo.Builder builder = CommonMessages.ExecutionEnvironmentInfo.newBuilder();</span>
<span class="nc" id="L606">		builder.setId(Utils.getMsgID(object.getDataClayID()));</span>
<span class="nc" id="L607">		builder.setHostname(object.getHostname());</span>
<span class="nc" id="L608">		builder.setName(object.getName());</span>
<span class="nc" id="L609">		builder.setPort(object.getPort());</span>
<span class="nc" id="L610">		builder.setDataClayInstanceID(Utils.getMsgID(object.getDataClayInstanceID()));</span>
<span class="nc" id="L611">		builder.setLanguage(object.getLang());</span>
<span class="nc" id="L612">		return builder.build();</span>
	}

	/**
	 * Return an object FROM grpc message
	 *
	 * @param msg object to convert
	 * @return the resulting object
	 */
	public static ExecutionEnvironment getExecutionEnvironment(
			final CommonMessages.ExecutionEnvironmentInfo msg) {
<span class="nc" id="L623">		ExecutionEnvironment eeLoc = new ExecutionEnvironment(</span>
<span class="nc" id="L624">				msg.getHostname(),</span>
<span class="nc" id="L625">				msg.getName(),</span>
<span class="nc" id="L626">				msg.getPort(),</span>
<span class="nc" id="L627">				msg.getLanguage(),</span>
<span class="nc" id="L628">				Utils.getDataClayInstanceID(msg.getDataClayInstanceID()));</span>
<span class="nc" id="L629">		eeLoc.setDataClayID(Utils.getExecutionEnvironmentID(msg.getId()));</span>
<span class="nc" id="L630">		return eeLoc;</span>
	}

	/**
	 * Return a message for GRPC call
	 *
	 * @param object object to convert
	 * @return the resulting message
	 */
	public static CommonMessages.StorageLocationInfo getStorageLocation(
			final StorageLocation object) {
<span class="nc" id="L641">		CommonMessages.StorageLocationInfo.Builder builder = CommonMessages.StorageLocationInfo.newBuilder();</span>
<span class="nc" id="L642">		builder.setId(Utils.getMsgID(object.getDataClayID()));</span>
<span class="nc" id="L643">		builder.setHostname(object.getHostname());</span>
<span class="nc" id="L644">		builder.setName(object.getName());</span>
<span class="nc" id="L645">		builder.setPort(object.getStorageTCPPort());</span>
<span class="nc" id="L646">		return builder.build();</span>
	}

	/**
	 * Return an object FROM grpc message
	 *
	 * @param msg object to convert
	 * @return the resulting object
	 */
	public static StorageLocation getStorageLocation(
			final CommonMessages.StorageLocationInfo msg) {
<span class="nc" id="L657">		StorageLocation stLoc = new StorageLocation(</span>
<span class="nc" id="L658">				msg.getHostname(),</span>
<span class="nc" id="L659">				msg.getName(),</span>
<span class="nc" id="L660">				msg.getPort());</span>
<span class="nc" id="L661">		stLoc.setDataClayID(Utils.getStorageLocationID(msg.getId()));</span>
<span class="nc" id="L662">		return stLoc;</span>
	}

	/**
	 * Return a message for GRPC call
	 *
	 * @param dataClayInstance object to convert
	 * @return the resulting message
	 */
	public static CommonMessages.DataClayInstance getDataClayInstance(
			final DataClayInstance dataClayInstance) {
<span class="nc" id="L673">		CommonMessages.DataClayInstance.Builder builder = CommonMessages.DataClayInstance.newBuilder();</span>
<span class="nc" id="L674">		builder.setId(Utils.getMsgID(dataClayInstance.getDcID()));</span>
<span class="nc" id="L675">		builder.addAllHosts(dataClayInstance.getHosts());</span>
<span class="nc" id="L676">		builder.addAllPorts(dataClayInstance.getPorts());</span>
<span class="nc" id="L677">		return builder.build();</span>
	}

	/**
	 * Return an object FROM grpc message
	 *
	 * @param dataClayInstanceMsg object to convert
	 * @return the resulting message
	 */
	public static DataClayInstance getDataClayInstance(
			final CommonMessages.DataClayInstance dataClayInstanceMsg) {
<span class="nc" id="L688">		String[] hosts = new String[dataClayInstanceMsg.getHostsCount()];</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">		for (int i = 0; i &lt; hosts.length; ++i) {</span>
<span class="nc" id="L690">			hosts[i] = dataClayInstanceMsg.getHosts(i);</span>
		}
<span class="nc" id="L692">		Integer[] ports = new Integer[dataClayInstanceMsg.getPortsCount()];</span>
<span class="nc bnc" id="L693" title="All 2 branches missed.">		for (int i = 0; i &lt; hosts.length; ++i) {</span>
<span class="nc" id="L694">			ports[i] = dataClayInstanceMsg.getPorts(i);</span>
		}
<span class="nc" id="L696">		return new DataClayInstance(Utils.getDataClayInstanceID(dataClayInstanceMsg.getId()),</span>
				hosts, ports);
	}


	/**
	 * Return a message containing an object with data (parameter or return)
	 * 
	 * @param volParamOrRet
	 *            an object with data (parameter or return)
	 * @return the resulting message
	 */
	public static CommonMessages.ObjectWithDataParamOrReturn getObjectWithDataParamOrReturn(
			final ObjectWithDataParamOrReturn volParamOrRet) {
		final CommonMessages.ObjectWithDataParamOrReturn.Builder volBuilder = CommonMessages.ObjectWithDataParamOrReturn
<span class="nc" id="L711">				.newBuilder();</span>
<span class="nc" id="L712">		final String classIDmsg = Utils.getMsgID(volParamOrRet.getClassID());</span>
<span class="nc" id="L713">		volBuilder.setClassid(classIDmsg);</span>
		// System.err.println(&quot;ObjwData class ID size : &quot; +
		// classIDmsg.getSerializedSize());

<span class="nc" id="L717">		final String objectIDmsg = Utils.getMsgID(volParamOrRet.getObjectID());</span>
<span class="nc" id="L718">		volBuilder.setOid(objectIDmsg);</span>
		// System.err.println(&quot;ObjwData oid ID size : &quot; +
		// objectIDmsg.getSerializedSize());

<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (volParamOrRet.getMetaData() != null) {</span>
<span class="nc" id="L723">			final CommonMessages.DataClayObjectMetaData mdata = Utils.getMetaData(volParamOrRet.getMetaData());</span>
<span class="nc" id="L724">			volBuilder.setMetadata(mdata);</span>
		}
		// System.err.println(&quot;ObjwData metadata size : &quot; + mdata.getSerializedSize());

<span class="nc" id="L728">		final ByteString objByteString = volParamOrRet.getSerializedBytes().getByteString();</span>
<span class="nc" id="L729">		volBuilder.setObjbytes(objByteString);</span>
		// System.err.println(&quot;ObjwData bytestring size : &quot; + objByteString.size());
<span class="nc" id="L731">		return volBuilder.build();</span>
	}

	/**
	 * Obtain the object with data (parameter or return) from the specified message
	 * 
	 * @param volParamOrRet
	 *            a message containing an object with data (parameter or return)
	 * @return the instance of an object with data (parameter or return)
	 */
	public static ObjectWithDataParamOrReturn getObjectWithDataParamOrReturn(
			final CommonMessages.ObjectWithDataParamOrReturn volParamOrRet) {
<span class="nc" id="L743">		final ObjectID oid = Utils.getObjectID(volParamOrRet.getOid());</span>
<span class="nc" id="L744">		final MetaClassID classid = Utils.getMetaClassID(volParamOrRet.getClassid());</span>
<span class="nc" id="L745">		final DataClayObjectMetaData mdata = Utils.getMetaData(volParamOrRet.getMetadata());</span>
<span class="nc" id="L746">		final DataClayByteArray byteArray = new DataClayByteArray(volParamOrRet.getObjbytes());</span>
<span class="nc" id="L747">		return new ObjectWithDataParamOrReturn(oid, classid, mdata, byteArray);</span>
	}

	/**
	 * Return a message containing a language object (parameter or return)
	 * 
	 * @param paramOrRet
	 *            the language object
	 * @return the resulting message
	 */
	public static CommonMessages.LanguageParamOrReturn getLanguageParamOrReturn(
			final LanguageParamOrReturn paramOrRet) {
<span class="nc" id="L759">		final CommonMessages.LanguageParamOrReturn.Builder builder = CommonMessages.LanguageParamOrReturn.newBuilder();</span>

<span class="nc" id="L761">		final CommonMessages.DataClayObjectMetaData mdata = Utils.getMetaData(paramOrRet.getMetaData());</span>
<span class="nc" id="L762">		builder.setMetadata(mdata);</span>
		// System.err.println(&quot;Lang param metadata lenght = &quot; +
		// mdata.getSerializedSize());
		// System.err.println(&quot;Lang param metadata = &quot; + Reflector.bytesToHex(
		// mdata.toByteArray()));

<span class="nc" id="L768">		final ByteString objBytes = paramOrRet.getSerializedBytes().getByteString();</span>
<span class="nc" id="L769">		builder.setObjbytes(objBytes);</span>
		// System.err.println(&quot;Lang param obj.bytes lenght = &quot; + objBytes.size());

<span class="nc" id="L772">		return builder.build();</span>
	}

	/**
	 * Return an instance of language object included in the specified message
	 * 
	 * @param paramOrRet
	 *            the message containing the language objet
	 * @return the language object
	 */
	public static LanguageParamOrReturn getLanguageParamOrReturn(
			final CommonMessages.LanguageParamOrReturn paramOrRet) {
<span class="nc" id="L784">		final DataClayObjectMetaData mdata = Utils.getMetaData(paramOrRet.getMetadata());</span>
<span class="nc" id="L785">		final DataClayByteArray byteArray = new DataClayByteArray(paramOrRet.getObjbytes());</span>
<span class="nc" id="L786">		return new LanguageParamOrReturn(mdata, byteArray);</span>
	}

	/**
	 * Return the immutable instance included in the specified message
	 * 
	 * @param paramOrRet
	 *            the message
	 * @return the resulting immutable instance
	 */
	public static ImmutableParamOrReturn getImmutableParamOrReturn(
			final CommonMessages.ImmutableParamOrReturn paramOrRet) {
<span class="nc" id="L798">		final DataClayByteArray byteArray = new DataClayByteArray(paramOrRet.getObjbytes());</span>
<span class="nc" id="L799">		return new ImmutableParamOrReturn(byteArray);</span>
	}

	/**
	 * Return a message including the specified immutable object
	 * 
	 * @param paramOrRet
	 *            the immutable object
	 * @return the resulting message
	 */
	public static CommonMessages.ImmutableParamOrReturn getImmutableParamOrReturn(
			final ImmutableParamOrReturn paramOrRet) {
		final CommonMessages.ImmutableParamOrReturn.Builder builder = CommonMessages.ImmutableParamOrReturn
<span class="nc" id="L812">				.newBuilder();</span>
<span class="nc" id="L813">		builder.setObjbytes(paramOrRet.getSerializedBytes().getByteString());</span>
<span class="nc" id="L814">		return builder.build();</span>
	}

	/**
	 * Return a message including the specified param or return object
	 * 
	 * @param paramOrRet
	 *            the object to be included within the message
	 * @return the resulting message
	 */
	public static CommonMessages.PersistentParamOrReturn getPersistentParamOrReturn(
			final PersistentParamOrReturn paramOrRet) {
		final CommonMessages.PersistentParamOrReturn.Builder builder = CommonMessages.PersistentParamOrReturn
<span class="nc" id="L827">				.newBuilder();</span>
<span class="nc" id="L828">		builder.setOid(Utils.getMsgID(paramOrRet.getObjectID()));</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">		if (paramOrRet.getHint() != null) {</span>
<span class="nc" id="L830">			builder.setHint(Utils.getMsgID(paramOrRet.getHint()));</span>
		}
<span class="nc bnc" id="L832" title="All 2 branches missed.">		if (paramOrRet.getClassID() != null) {</span>
<span class="nc" id="L833">			builder.setClassID(Utils.getMsgID(paramOrRet.getClassID()));</span>
		}
<span class="nc bnc" id="L835" title="All 2 branches missed.">		if (paramOrRet.getExtDataClayID() != null) {</span>
<span class="nc" id="L836">			builder.setExtDataClayID(Utils.getMsgID(paramOrRet.getExtDataClayID()));</span>
		}

<span class="nc" id="L839">		return builder.build();</span>
	}

	/**
	 * Return the param or return object included in the specified message
	 * 
	 * @param paramOrRet
	 *            the message
	 * @return the resulting param or return object
	 */
	public static PersistentParamOrReturn getPersistentParamOrReturn(
			final CommonMessages.PersistentParamOrReturn paramOrRet) {

<span class="nc" id="L852">		MetaClassID classID = null;</span>
<span class="nc" id="L853">		ExecutionEnvironmentID hint = null;</span>
<span class="nc" id="L854">		DataClayInstanceID extDataClayID = null;</span>
<span class="nc" id="L855">		hint = Utils.getExecutionEnvironmentID(paramOrRet.getHint());</span>
<span class="nc" id="L856">		classID = Utils.getMetaClassID(paramOrRet.getClassID());</span>
<span class="nc" id="L857">		extDataClayID = Utils.getDataClayInstanceID(paramOrRet.getExtDataClayID());</span>


<span class="nc" id="L860">		return new PersistentParamOrReturn(Utils.getObjectID(paramOrRet.getOid()), hint, classID, extDataClayID);</span>
	}

	/**
	 * Return the message including the specified serialized param or return object
	 * 
	 * @param serParamsOrRet
	 *            a serialized param or return object
	 * @return the resulting message
	 */
	public static CommonMessages.SerializedParametersOrReturn getParamsOrReturn(
			final SerializedParametersOrReturn serParamsOrRet) {

		final CommonMessages.SerializedParametersOrReturn.Builder builder = CommonMessages.SerializedParametersOrReturn
<span class="nc" id="L874">				.newBuilder();</span>

<span class="nc" id="L876">		builder.setNumParams(serParamsOrRet.getNumParams());</span>
<span class="nc bnc" id="L877" title="All 2 branches missed.">		for (final Entry&lt;Integer, ImmutableParamOrReturn&gt; langEntry : serParamsOrRet.getImmObjs().entrySet()) {</span>
<span class="nc" id="L878">			final CommonMessages.ImmutableParamOrReturn immParamMsg = Utils</span>
<span class="nc" id="L879">					.getImmutableParamOrReturn(langEntry.getValue());</span>
<span class="nc" id="L880">			builder.putImmParams(langEntry.getKey(), immParamMsg);</span>
			// System.err.println(&quot;Imm param bytes lenght = &quot; +
			// immParamMsg.getSerializedSize());

<span class="nc" id="L884">		}</span>
<span class="nc bnc" id="L885" title="All 2 branches missed.">		for (final Entry&lt;Integer, LanguageParamOrReturn&gt; langEntry : serParamsOrRet.getLangObjs().entrySet()) {</span>
<span class="nc" id="L886">			final CommonMessages.LanguageParamOrReturn langParamMsg = Utils</span>
<span class="nc" id="L887">					.getLanguageParamOrReturn(langEntry.getValue());</span>
<span class="nc" id="L888">			builder.putLangParams(langEntry.getKey(), langParamMsg);</span>
			// System.err.println(&quot;Lang param bytes lenght = &quot; +
			// langParamMsg.getSerializedSize());

<span class="nc" id="L892">		}</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">		for (final Entry&lt;Integer, PersistentParamOrReturn&gt; entry : serParamsOrRet.getPersistentRefs().entrySet()) {</span>
<span class="nc" id="L894">			final CommonMessages.PersistentParamOrReturn persMsg = Utils.getPersistentParamOrReturn(entry.getValue());</span>
<span class="nc" id="L895">			builder.putPersParams(entry.getKey(), persMsg);</span>
			// System.err.println(&quot;Pers param bytes lenght = &quot; +
			// persMsg.getSerializedSize());
<span class="nc" id="L898">		}</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">		for (final Entry&lt;Integer, ObjectWithDataParamOrReturn&gt; entry : serParamsOrRet.getVolatileObjs().entrySet()) {</span>
<span class="nc" id="L900">			final CommonMessages.ObjectWithDataParamOrReturn objDataParamMsg = Utils</span>
<span class="nc" id="L901">					.getObjectWithDataParamOrReturn(entry.getValue());</span>
<span class="nc" id="L902">			builder.putVolatileParams(entry.getKey(), objDataParamMsg);</span>
			// System.err.println(&quot;Obj.Data param bytes lenght = &quot; +
			// objDataParamMsg.getSerializedSize());

<span class="nc" id="L906">		}</span>
<span class="nc" id="L907">		return builder.build();</span>
	}

	/**
	 * Return a serialized param or return object from the specified message
	 * 
	 * @param serParamsOrRetMsg
	 *            the message
	 * @return the serialized param or return object from the message
	 */
	public static SerializedParametersOrReturn getParamsOrReturn(
			final CommonMessages.SerializedParametersOrReturn serParamsOrRetMsg) {
<span class="nc" id="L919">		final int numParams = serParamsOrRetMsg.getNumParams();</span>
<span class="nc" id="L920">		final Map&lt;Integer, ImmutableParamOrReturn&gt; immObjs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L921">		final Map&lt;Integer, LanguageParamOrReturn&gt; langObjs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L922">		final Map&lt;Integer, ObjectWithDataParamOrReturn&gt; volObjs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc" id="L923">		final Map&lt;Integer, PersistentParamOrReturn&gt; persObjs = new ConcurrentHashMap&lt;&gt;();</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">		for (final Entry&lt;Integer, CommonMessages.ImmutableParamOrReturn&gt; entry : serParamsOrRetMsg.getImmParamsMap()</span>
<span class="nc" id="L925">				.entrySet()) {</span>
<span class="nc" id="L926">			immObjs.put(entry.getKey(), Utils.getImmutableParamOrReturn(entry.getValue()));</span>
<span class="nc" id="L927">		}</span>
<span class="nc bnc" id="L928" title="All 2 branches missed.">		for (final Entry&lt;Integer, CommonMessages.LanguageParamOrReturn&gt; entry : serParamsOrRetMsg.getLangParamsMap()</span>
<span class="nc" id="L929">				.entrySet()) {</span>
<span class="nc" id="L930">			langObjs.put(entry.getKey(), Utils.getLanguageParamOrReturn(entry.getValue()));</span>
<span class="nc" id="L931">		}</span>
<span class="nc bnc" id="L932" title="All 2 branches missed.">		for (final Entry&lt;Integer, CommonMessages.ObjectWithDataParamOrReturn&gt; entry : serParamsOrRetMsg</span>
<span class="nc" id="L933">				.getVolatileParamsMap().entrySet()) {</span>
<span class="nc" id="L934">			volObjs.put(entry.getKey(), Utils.getObjectWithDataParamOrReturn(entry.getValue()));</span>
<span class="nc" id="L935">		}</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">		for (final Entry&lt;Integer, CommonMessages.PersistentParamOrReturn&gt; entry : serParamsOrRetMsg.getPersParamsMap()</span>
<span class="nc" id="L937">				.entrySet()) {</span>
<span class="nc" id="L938">			persObjs.put(entry.getKey(), Utils.getPersistentParamOrReturn(entry.getValue()));</span>
<span class="nc" id="L939">		}</span>
<span class="nc" id="L940">		return new SerializedParametersOrReturn(numParams, immObjs, langObjs, volObjs, persObjs);</span>
	}

	private static final int MAX_BYTES_PER_LINE = 16;
	private static final int MAX_CHARS_PER_BYTE = 10;
	private static final String COLUMN_SEPARATOR = &quot;|&quot;;
	private static final String LINE_SEPARATOR = &quot;-&quot;;

<span class="nc" id="L948">	protected static final char[] hexArray = &quot;0123456789ABCDEF&quot;.toCharArray();</span>

	/**
	 * Get bytes to hexadecimal Strings
	 * 
	 * @param bytes
	 *            Bytes
	 * @return Hexadecimal strings
	 */
	public static synchronized Queue&lt;String&gt; bytesToHex(final byte[] bytes) {
<span class="nc" id="L958">		final char[] hexChars = new char[bytes.length * 2];</span>
<span class="nc bnc" id="L959" title="All 2 branches missed.">		for (int j = 0; j &lt; bytes.length; j++) {</span>
<span class="nc" id="L960">			final int v = bytes[j] &amp; 0xFF;</span>
<span class="nc" id="L961">			hexChars[j * 2] = hexArray[v &gt;&gt;&gt; 4];</span>
<span class="nc" id="L962">			hexChars[j * 2 + 1] = hexArray[v &amp; 0x0F];</span>
		}
<span class="nc" id="L964">		final Queue&lt;String&gt; listBytes = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">		for (final char hexChar : hexChars) {</span>
<span class="nc" id="L966">			listBytes.add(String.valueOf(hexChar));</span>
		}
<span class="nc" id="L968">		return listBytes;</span>
	}

	/**
	 * Get number of bytes needed for a GRPC tag
	 * 
	 * @param numNextBytes
	 *            Number of bytes to represent
	 * @return Number of bytes needed for a GRPC tag.
	 */
	public static synchronized int getNumBytesNeededInVLQInt(final int numNextBytes) {
<span class="nc" id="L979">		int bytesNeeded = 0;</span>
<span class="nc" id="L980">		int curMaxSize = 0;</span>
<span class="nc" id="L981">		final int bitsAvailablePerByte = 7;</span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">		while (curMaxSize &lt; numNextBytes) {</span>
<span class="nc" id="L983">			bytesNeeded++;</span>
<span class="nc" id="L984">			curMaxSize = (int) Math.pow(2, bitsAvailablePerByte * bytesNeeded);</span>
		}
<span class="nc" id="L986">		return bytesNeeded;</span>
	}

	/**
	 * Print bytes header
	 */
	public static synchronized void printBytesHeader(final Queue&lt;String&gt; byteStr, final int byteIndex) {
<span class="nc" id="L993">		System.out.println();</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">		for (int j = 0; j &lt; MAX_BYTES_PER_LINE; ++j) {</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">			for (int i = 0; i &lt; MAX_CHARS_PER_BYTE; ++i) {</span>
<span class="nc" id="L996">				System.out.print(&quot;=&quot;);</span>
			}
		}
<span class="nc" id="L999">		System.out.println();</span>

<span class="nc" id="L1001">		System.out.print(COLUMN_SEPARATOR);</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">		for (int j = 0; j &lt; MAX_BYTES_PER_LINE; ++j) {</span>
<span class="nc" id="L1003">			int maxLength = MAX_CHARS_PER_BYTE - 1;</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">			for (int i = 0; i &lt; MAX_CHARS_PER_BYTE - 1; ++i) {</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">				if (i == Math.round(MAX_CHARS_PER_BYTE / 2.0) - 1) {</span>
<span class="nc" id="L1006">					System.out.print(j + byteIndex);</span>
<span class="nc" id="L1007">					maxLength = maxLength - String.valueOf(j + byteIndex).length();</span>
				} else {
<span class="nc" id="L1009">					System.out.print(&quot; &quot;);</span>
<span class="nc bnc" id="L1010" title="All 2 branches missed.">					if (i &gt;= maxLength) {</span>
<span class="nc" id="L1011">						break;</span>
					}
				}
			}
<span class="nc" id="L1015">			System.out.print(COLUMN_SEPARATOR);</span>
		}
<span class="nc" id="L1017">		System.out.println();</span>

<span class="nc bnc" id="L1019" title="All 2 branches missed.">		for (int j = 0; j &lt; MAX_BYTES_PER_LINE; ++j) {</span>
<span class="nc bnc" id="L1020" title="All 2 branches missed.">			for (int i = 0; i &lt; MAX_CHARS_PER_BYTE; ++i) {</span>
<span class="nc" id="L1021">				System.out.print(LINE_SEPARATOR);</span>
			}
		}
<span class="nc" id="L1024">		System.out.println();</span>
<span class="nc" id="L1025">	}</span>

	/**
	 * Print grpc tag
	 * 
	 * @param typeName
	 *            name of type
	 * @param serializedSize
	 *            Size of message (next message identified by tag)
	 * @param byteStr
	 *            Hexadecimal bytes
	 * @param currentByteIndex
	 *            Current byte index
	 * @return Current byte index
	 */
	private static synchronized int printGrpcTagField(final String typeName, final int serializedSize,
			final Queue&lt;String&gt; byteStr, final int currentByteIndex) {
<span class="nc" id="L1042">		final int numBytesNeededPerTag = getNumBytesNeededInVLQInt(serializedSize) + 1; // tag + numBytes</span>
<span class="nc" id="L1043">		return printBytes(typeName, numBytesNeededPerTag, byteStr, currentByteIndex);</span>
	}

	/**
	 * Print N bytes
	 * 
	 * @param typeName
	 *            Tag (if needed)
	 * @param numBytes
	 *            Num bytes to print
	 * @param byteStr
	 *            Hexadecimal bytes
	 * @param byteIndex
	 *            Current byte index
	 * @return Current byte index
	 */
	private static synchronized int printBytes(final String typeName, final int numBytes, final Queue&lt;String&gt; byteStr,
			final int byteIndex) {
<span class="nc" id="L1061">		int currentByteIndex = byteIndex;</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">		for (int i = 0; i &lt; numBytes; ++i) {</span>

<span class="nc bnc" id="L1064" title="All 2 branches missed.">			if (currentByteIndex % MAX_BYTES_PER_LINE == 0) {</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">				if (currentByteIndex &gt; 0) {</span>
<span class="nc" id="L1066">					System.out.print(COLUMN_SEPARATOR);</span>
				}
<span class="nc" id="L1068">				printBytesHeader(byteStr, currentByteIndex);</span>
			}

<span class="nc" id="L1071">			String tagToWrite = COLUMN_SEPARATOR + &quot;0x&quot;;</span>

<span class="nc bnc" id="L1073" title="All 4 branches missed.">			if (byteStr == null || byteStr.isEmpty()) {</span>
<span class="nc" id="L1074">				tagToWrite += &quot;??&quot;;</span>
			} else {
<span class="nc" id="L1076">				tagToWrite += byteStr.poll();</span>
<span class="nc" id="L1077">				tagToWrite += byteStr.poll();</span>
			}
<span class="nc" id="L1079">			tagToWrite += &quot; &quot;;</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">			if (typeName != null) {</span>
<span class="nc" id="L1081">				tagToWrite += typeName;</span>
			}

<span class="nc" id="L1084">			System.out.print(tagToWrite); // Embedded Message</span>
<span class="nc" id="L1085">			final int freeSpace = MAX_CHARS_PER_BYTE - tagToWrite.length(); // 23*Nbytes spaces</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">			for (int j = 0; j &lt; freeSpace; ++j) {</span>
<span class="nc" id="L1087">				System.out.print(&quot; &quot;);</span>
			}
<span class="nc" id="L1089">			currentByteIndex++;</span>
		}
<span class="nc" id="L1091">		return currentByteIndex;</span>
	}

	/**
	 * Print GRPC message (pretty)
	 * 
	 * @param msg
	 *            GRPC message
	 */
	public static synchronized void printMsg(final com.google.protobuf.GeneratedMessageV3 msg) {
<span class="nc" id="L1101">		printMsg(msg, 0, new ConcurrentHashMap&lt;String, String&gt;());</span>
<span class="nc" id="L1102">	}</span>

	/**
	 * Print grpc message Aux function
	 * 
	 * @param msg
	 *            GRPC message
	 * @param byteIndex
	 *            Current byte index
	 * @param tagsMap
	 *            Tags map
	 * @return Current byte index
	 */
	private static synchronized int printMsg(final com.google.protobuf.GeneratedMessageV3 msg, final int byteIndex,
			final Map&lt;String, String&gt; tagsMap) {

<span class="nc" id="L1118">		boolean isFirst = false;</span>
<span class="nc" id="L1119">		int currentByteIndex = byteIndex;</span>
<span class="nc bnc" id="L1120" title="All 2 branches missed.">		if (currentByteIndex == 0) {</span>
<span class="nc" id="L1121">			System.out.println(&quot;Message size : &quot; + msg.getSerializedSize());</span>
<span class="nc" id="L1122">			isFirst = true;</span>
		}

<span class="nc" id="L1125">		final Queue&lt;String&gt; bytesAsStr = bytesToHex(msg.toByteArray());</span>

<span class="nc bnc" id="L1127" title="All 2 branches missed.">		for (final Entry&lt;FieldDescriptor, Object&gt; fieldEntry : msg.getAllFields().entrySet()) {</span>
<span class="nc" id="L1128">			final FieldDescriptor fDescriptor = fieldEntry.getKey();</span>

			// print value
<span class="nc" id="L1131">			final Object fieldValue = fieldEntry.getValue();</span>

			// Print value
<span class="nc" id="L1134">			currentByteIndex = printValue(fieldValue, fDescriptor.getName(), bytesAsStr, currentByteIndex, tagsMap);</span>

<span class="nc" id="L1136">		}</span>
<span class="nc bnc" id="L1137" title="All 2 branches missed.">		if (isFirst) {</span>
<span class="nc" id="L1138">			System.out.println();</span>
<span class="nc bnc" id="L1139" title="All 2 branches missed.">			for (int j = 0; j &lt; MAX_BYTES_PER_LINE; ++j) {</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">				for (int i = 0; i &lt; MAX_CHARS_PER_BYTE; ++i) {</span>
<span class="nc" id="L1141">					System.out.print(&quot;=&quot;);</span>
				}
			}
<span class="nc" id="L1144">			System.out.println();</span>
<span class="nc" id="L1145">			final List&lt;String&gt; orderedList = new ArrayList&lt;&gt;(tagsMap.values());</span>
<span class="nc" id="L1146">			java.util.Collections.sort(orderedList);</span>
<span class="nc" id="L1147">			int curInColumn = 0;</span>
<span class="nc bnc" id="L1148" title="All 2 branches missed.">			for (final String currentStr : orderedList) {</span>
<span class="nc bnc" id="L1149" title="All 2 branches missed.">				for (final Entry&lt;String, String&gt; tagEntry : tagsMap.entrySet()) {</span>
<span class="nc bnc" id="L1150" title="All 2 branches missed.">					if (tagEntry.getValue().equals(currentStr)) {</span>
<span class="nc" id="L1151">						final String toPrint = &quot;|&quot; + tagEntry.getValue() + &quot;: &quot; + tagEntry.getKey();</span>
<span class="nc" id="L1152">						System.out.print(toPrint);</span>
<span class="nc" id="L1153">						curInColumn++;</span>
<span class="nc bnc" id="L1154" title="All 2 branches missed.">						if (curInColumn % 5 == 0) {</span>
<span class="nc" id="L1155">							System.out.println();</span>
						} else {
<span class="nc" id="L1157">							final int freeSpaces = MAX_CHARS_PER_BYTE * 3 - toPrint.length();</span>
<span class="nc bnc" id="L1158" title="All 2 branches missed.">							for (int i = 0; i &lt; freeSpaces; ++i) {</span>
<span class="nc" id="L1159">								System.out.print(&quot; &quot;);</span>
							}
						}
<span class="nc" id="L1162">						break;</span>
					}
<span class="nc" id="L1164">				}</span>
<span class="nc" id="L1165">			}</span>
<span class="nc" id="L1166">			System.out.println();</span>
		}

<span class="nc" id="L1169">		return currentByteIndex;</span>
	}

	/**
	 * Print Field Tag
	 * 
	 * @param fieldDescriptorName
	 *            Field descriptor
	 * @param bytesAsStr
	 *            Hexadecimal bytes
	 * @param byteIndex
	 *            Current byte index
	 * @param tagsMap
	 *            tags map
	 * @return Current byte index
	 */
	private static synchronized int printFTTag(final String fieldDescriptorName, final Queue&lt;String&gt; bytesAsStr,
			final int byteIndex, final Map&lt;String, String&gt; tagsMap) {
<span class="nc" id="L1187">		String tagName = tagsMap.get(fieldDescriptorName);</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">		if (tagName == null) {</span>
<span class="nc" id="L1189">			tagName = &quot;FT&quot; + tagsMap.size();</span>
<span class="nc" id="L1190">			tagsMap.put(fieldDescriptorName, tagName);</span>
		}
<span class="nc" id="L1192">		return printGrpcTagField(tagName, 0, bytesAsStr, byteIndex);</span>
	}

	/**
	 * Print Embedded message Tag
	 * 
	 * @param fieldDescriptorName
	 *            Field descriptor
	 * @param bytesAsStr
	 *            Hexadecimal bytes
	 * @param byteIndex
	 *            Current byte index
	 * @param tagsMap
	 *            tags map
	 * @param serializedSize
	 *            size of the message
	 * @return Current byte index
	 */
	private static synchronized int printEMTag(final String fieldDescriptorName, final Queue&lt;String&gt; bytesAsStr,
			final int byteIndex, final Map&lt;String, String&gt; tagsMap, final int serializedSize) {
<span class="nc" id="L1212">		String tagName = tagsMap.get(fieldDescriptorName);</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">		if (tagName == null) {</span>
<span class="nc" id="L1214">			tagName = &quot;EM&quot; + tagsMap.size();</span>
<span class="nc" id="L1215">			tagsMap.put(fieldDescriptorName, tagName);</span>
		}
<span class="nc" id="L1217">		return printGrpcTagField(tagName, serializedSize, bytesAsStr, byteIndex);</span>
	}

	/**
	 * Get serialized size of field value provided
	 * 
	 * @param fieldValue
	 *            Field value
	 * @return serialized size
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	private static synchronized int getSerializedSize(final Object fieldValue) {
<span class="nc bnc" id="L1229" title="All 2 branches missed.">		if (fieldValue instanceof Long) {</span>
<span class="nc" id="L1230">			return 8;</span>
<span class="nc bnc" id="L1231" title="All 2 branches missed.">		} else if (fieldValue instanceof Integer) {</span>
<span class="nc" id="L1232">			return Math.max(1, getNumBytesNeededInVLQInt((Integer) fieldValue));</span>
<span class="nc bnc" id="L1233" title="All 2 branches missed.">		} else if (fieldValue instanceof com.google.protobuf.GeneratedMessageV3) {</span>
<span class="nc" id="L1234">			final com.google.protobuf.GeneratedMessageV3 fieldMsg = (com.google.protobuf.GeneratedMessageV3) fieldValue;</span>
<span class="nc" id="L1235">			return Math.max(2, fieldMsg.getSerializedSize());</span>
<span class="nc bnc" id="L1236" title="All 2 branches missed.">		} else if (fieldValue instanceof List) {</span>
<span class="nc" id="L1237">			int acumSize = 0;</span>
<span class="nc bnc" id="L1238" title="All 2 branches missed.">			for (final Object fieldElement : (List) fieldValue) {</span>
<span class="nc" id="L1239">				acumSize += getSerializedSize(fieldElement);</span>
<span class="nc" id="L1240">			}</span>
<span class="nc" id="L1241">			return acumSize;</span>
<span class="nc bnc" id="L1242" title="All 2 branches missed.">		} else if (fieldValue instanceof MapEntry) {</span>
<span class="nc" id="L1243">			final MapEntry entry = (MapEntry) fieldValue;</span>
<span class="nc" id="L1244">			return entry.getSerializedSize();</span>
<span class="nc bnc" id="L1245" title="All 2 branches missed.">		} else if (fieldValue instanceof ByteString) {</span>
<span class="nc" id="L1246">			final ByteString bString = (ByteString) fieldValue;</span>
<span class="nc" id="L1247">			return bString.size();</span>
		}
<span class="nc" id="L1249">		return 0;</span>
	}

	/**
	 * Print field value
	 * 
	 * @param fieldValue
	 *            Field value
	 * @param fieldDescriptorName
	 *            Field descriptor
	 * @param bytesAsStr
	 *            Hexadecimal bytes
	 * @param byteIndex
	 *            Current byte index
	 * @param tagsMap
	 *            tags map
	 * @return Current byte index
	 */
	@SuppressWarnings(&quot;rawtypes&quot;)
	private static synchronized int printValue(final Object fieldValue, final String fieldDescriptorName,
			final Queue&lt;String&gt; bytesAsStr, final int byteIndex, final Map&lt;String, String&gt; tagsMap) {

<span class="nc" id="L1271">		int currentByteIndex = byteIndex;</span>

<span class="nc bnc" id="L1273" title="All 2 branches missed.">		if (fieldValue instanceof Long) {</span>
<span class="nc" id="L1274">			final int size = getSerializedSize(fieldValue);</span>
<span class="nc" id="L1275">			currentByteIndex = printFTTag(fieldDescriptorName, bytesAsStr, currentByteIndex, tagsMap);</span>
<span class="nc" id="L1276">			currentByteIndex = printBytes(null, size, bytesAsStr, currentByteIndex);</span>
<span class="nc bnc" id="L1277" title="All 2 branches missed.">		} else if (fieldValue instanceof Integer) {</span>
<span class="nc" id="L1278">			final int size = getSerializedSize(fieldValue);</span>
<span class="nc" id="L1279">			currentByteIndex = printFTTag(fieldDescriptorName, bytesAsStr, currentByteIndex, tagsMap);</span>
<span class="nc" id="L1280">			currentByteIndex = printBytes(null, size, bytesAsStr, currentByteIndex);</span>
<span class="nc bnc" id="L1281" title="All 2 branches missed.">		} else if (fieldValue instanceof com.google.protobuf.GeneratedMessageV3) {</span>
<span class="nc" id="L1282">			final int size = getSerializedSize(fieldValue);</span>
<span class="nc" id="L1283">			final com.google.protobuf.GeneratedMessageV3 fieldMsg = (com.google.protobuf.GeneratedMessageV3) fieldValue;</span>
<span class="nc" id="L1284">			currentByteIndex = printEMTag(fieldDescriptorName, bytesAsStr, currentByteIndex, tagsMap, size);</span>
<span class="nc" id="L1285">			currentByteIndex = printMsg(fieldMsg, currentByteIndex, tagsMap);</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">		} else if (fieldValue instanceof List) {</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">			for (final Object fieldElement : (List) fieldValue) {</span>
<span class="nc" id="L1288">				currentByteIndex = printValue(fieldElement, &quot;ListElement&quot;, bytesAsStr, currentByteIndex, tagsMap);</span>
<span class="nc" id="L1289">			}</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">		} else if (fieldValue instanceof MapEntry) {</span>
<span class="nc" id="L1291">			final int size = getSerializedSize(fieldValue);</span>
<span class="nc" id="L1292">			currentByteIndex = printEMTag(&quot;MapEntry&quot;, bytesAsStr, currentByteIndex, tagsMap, size);</span>
<span class="nc" id="L1293">			final MapEntry entry = (MapEntry) fieldValue;</span>
<span class="nc" id="L1294">			currentByteIndex = printValue(entry.getKey(), &quot;MapKey&quot;, bytesAsStr, currentByteIndex, tagsMap);</span>
<span class="nc" id="L1295">			currentByteIndex = printValue(entry.getValue(), &quot;MapValue&quot;, bytesAsStr, currentByteIndex, tagsMap);</span>
<span class="nc bnc" id="L1296" title="All 2 branches missed.">		} else if (fieldValue instanceof ByteString) {</span>
<span class="nc" id="L1297">			final int size = getSerializedSize(fieldValue);</span>
<span class="nc" id="L1298">			currentByteIndex = printEMTag(fieldDescriptorName, bytesAsStr, currentByteIndex, tagsMap, size);</span>
<span class="nc" id="L1299">			currentByteIndex = printBytes(null, size, bytesAsStr, currentByteIndex);</span>

<span class="nc" id="L1301">		} else {</span>
<span class="nc" id="L1302">			System.err.println(&quot;Missing &quot; + fieldValue.getClass().getName());</span>
		}

<span class="nc" id="L1305">		return currentByteIndex;</span>

	}

	// ##**EXCEPTIONS UTILS**##

	/**
	 * Return Exception Infos for gRPC message
	 * 
	 * @param isExc
	 *            True if there is an exception
	 * @param serializedExc
	 *            The exception serialized in a DCBuffer
	 * @param excMessage
	 *            The formatted Message + Code + Server Stack of the Exception
	 * @return builder of proto ExceptionInfo message
	 */
	private static CommonMessages.ExceptionInfo getExcInfo(final boolean isExc, final ByteString serializedExc,
			final ByteString excMessage) {
<span class="nc" id="L1324">		final CommonMessages.ExceptionInfo.Builder builder = CommonMessages.ExceptionInfo.newBuilder();</span>

<span class="nc" id="L1326">		builder.setIsException(isExc);</span>
<span class="nc bnc" id="L1327" title="All 2 branches missed.">		if (serializedExc != null) {</span>
<span class="nc" id="L1328">			builder.setSerializedException(serializedExc);</span>
		}
<span class="nc bnc" id="L1330" title="All 2 branches missed.">		if (excMessage != null) {</span>
<span class="nc" id="L1331">			builder.setExceptionMessage(excMessage);</span>
		}

<span class="nc" id="L1334">		return builder.build();</span>
	}

	/**
	 * get Exception StackTrace
	 * 
	 * @param e
	 *            Exception
	 * @return string StackTrace
	 */
	private static String exceptionStacktraceToString(final Exception e) {
<span class="nc" id="L1345">		final ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L1346">		final PrintStream ps = new PrintStream(baos);</span>
<span class="nc" id="L1347">		e.printStackTrace(ps);</span>
<span class="nc" id="L1348">		ps.close();</span>
<span class="nc" id="L1349">		return baos.toString();</span>
	}

	/**
	 * get Serialized Exception Message to send
	 * 
	 * @param e
	 *            DataClayException
	 * @return message + StackTrace formatted
	 */
	private static ByteString getSerializedExceptionMessage(final DataClayException e) {

<span class="nc" id="L1361">		final String stack = exceptionStacktraceToString(e);</span>
<span class="nc" id="L1362">		final String excMess = e.getLocalizedMessage();</span>
<span class="nc" id="L1363">		final String errorcode = e.getErrorcode().toString();</span>

<span class="nc" id="L1365">		final char[] chars = new char[146];</span>
<span class="nc" id="L1366">		Arrays.fill(chars, '-');</span>
<span class="nc" id="L1367">		final String s = new String(chars);</span>

<span class="nc" id="L1369">		final String joined = new StringJoiner(&quot;&quot;).add(&quot;\n&quot;).add(s).add(&quot;\n Error Message: &quot;).add(excMess)</span>
<span class="nc" id="L1370">				.add(&quot;\n\n Error Code: &quot;).add(errorcode).add(&quot;\n&quot;).add(s).add(&quot;\n Server StackTrace: &quot;).add(stack)</span>
<span class="nc" id="L1371">				.add(s).toString();</span>

<span class="nc" id="L1373">		return ByteString.copyFromUtf8(joined);</span>
	}

	/**
	 * Serialize Exception
	 * 
	 * @param ex
	 *            Exception to serialize
	 * @return Serialized exception
	 */
	public static ExceptionInfo serializeException(final Exception ex) {

		// wrap exception if needed
<span class="nc" id="L1386">		DataClayException dcEx = null;</span>
<span class="nc bnc" id="L1387" title="All 2 branches missed.">		if (ex instanceof DataClayException) {</span>
<span class="nc" id="L1388">			dcEx = (DataClayException) ex;</span>
		} else {
<span class="nc" id="L1390">			dcEx = new DataClayException(ex);</span>
		}

		// Create response with exception
<span class="nc bnc" id="L1394" title="All 2 branches missed.">		if (DEBUG_ENABLED) {</span>
<span class="nc" id="L1395">			LOGGER.debug(&quot;[==EXCEPTION==] Sending exception {}. Activate trace to see stack trace&quot;, ex.getClass().getName());</span>
<span class="nc" id="L1396">			LOGGER.debug(&quot;[==EXCEPTION==] Sending DataClayException GRPC response: &quot;, ex);</span>
		}
<span class="nc" id="L1398">		final DataClayByteBuffer dcBuffer = SerializationLibUtils.newByteBuffer();</span>
<span class="nc" id="L1399">		byte[] serializedBytes = null;</span>
<span class="nc" id="L1400">		ExceptionInfo resp = null;</span>
		try {
			// Serialize exception and set the ExcInfo message
<span class="nc" id="L1403">			dcEx.serialize(dcBuffer, false, null, null, null, null);</span>
<span class="nc" id="L1404">			serializedBytes = dcBuffer.getArray();</span>

<span class="nc" id="L1406">			resp = (Utils.getExcInfo(true, ByteString.copyFrom(serializedBytes),</span>
<span class="nc" id="L1407">					Utils.getSerializedExceptionMessage(dcEx)));</span>
		} finally {
<span class="nc" id="L1409">			dcBuffer.release();</span>

		}
<span class="nc" id="L1412">		return resp;</span>
	}

	/**
	 * Verifies if response message isException and if this is the case print and raise it properly
	 * 
	 * @param response
	 *            ExceptionInfo response message
	 */
	public static void checkIsExc(final ExceptionInfo response) {
<span class="nc bnc" id="L1422" title="All 2 branches missed.">		if (response.getIsException()) {</span>

<span class="nc" id="L1424">			final DataClayException dcEx = new DataClayException();</span>
<span class="nc" id="L1425">			dcEx.setExceptionMessage(response.getExceptionMessage().toStringUtf8());</span>
<span class="nc" id="L1426">			final ByteString serializedExceptionBytes = response.getSerializedException();</span>
<span class="nc bnc" id="L1427" title="All 2 branches missed.">			if (serializedExceptionBytes.size() == 0) {</span>
				// Python generic exception without bytes, just message
<span class="nc" id="L1429">				throw dcEx;</span>
			} else {
<span class="nc" id="L1431">				final DataClayByteArray serializedException = new DataClayByteArray(serializedExceptionBytes);</span>
<span class="nc" id="L1432">				DataClayDeserializationLib.createBufferAndDeserialize(serializedException, dcEx, null, null, null);</span>

				// WARNING: Currently only sending runtime exceptions
<span class="nc" id="L1435">				final RuntimeException cause = (RuntimeException) dcEx.getCause();</span>
<span class="nc bnc" id="L1436" title="All 2 branches missed.">				if (DEBUG_ENABLED) {</span>
<span class="nc" id="L1437">					LOGGER.debug(&quot;[==EXCEPTION==] Sending exception {}. Activate trace to see stack trace&quot;, cause.getMessage());</span>
<span class="nc" id="L1438">					LOGGER.trace(&quot;[==EXCEPTION==] Received DataClayException GRPC response: &quot;, cause);</span>
				}
<span class="nc" id="L1440">				throw cause;</span>

			}
		}
<span class="nc" id="L1444">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>